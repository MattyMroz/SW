#include"stm32l4xx_hal.h"#ifdefHAL_RCC_MODULE_ENABLED#defineHSE_TIMEOUT_VALUEHSE_STARTUP_TIMEOUT#defineHSI_TIMEOUT_VALUE2U#defineMSI_TIMEOUT_VALUE2U#ifdefined(RCC_CSR_LSIPREDIV)#defineLSI_TIMEOUT_VALUE17U#else#defineLSI_TIMEOUT_VALUE2U#endif#defineHSI48_TIMEOUT_VALUE2U#definePLL_TIMEOUT_VALUE2U#defineCLOCKSWITCH_TIMEOUT_VALUE5000U#define__MCO1_CLK_ENABLE()__HAL_RCC_GPIOA_CLK_ENABLE()#defineMCO1_GPIO_PORTGPIOA#defineMCO1_PINGPIO_PIN_8#defineRCC_PLL_OSCSOURCE_CONFIG(__HAL_RCC_PLLSOURCE__)\(MODIFY_REG(RCC->PLLCFGR,RCC_PLLCFGR_PLLSRC,(__HAL_RCC_PLLSOURCE__)))staticHAL_StatusTypeDefRCC_SetFlashLatencyFromMSIRange(uint32_tmsirange);#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)staticuint32_tRCC_GetSysClockFreqFromPLLSource(void);#endifHAL_StatusTypeDefHAL_RCC_DeInit(void){uint32_ttickstart;SET_BIT(RCC->CR,RCC_CR_MSION);tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_MSIRDY)==0U){if((HAL_GetTick()-tickstart)>MSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}MODIFY_REG(RCC->CR,RCC_CR_MSIRANGE,RCC_MSIRANGE_6);CLEAR_REG(RCC->CFGR);SystemCoreClock=MSI_VALUE;if(HAL_InitTick(uwTickPrio)!=HAL_OK){returnHAL_ERROR;}tickstart=HAL_GetTick();while(READ_BIT(RCC->CFGR,RCC_CFGR_SWS)!=RCC_CFGR_SWS_MSI){if((HAL_GetTick()-tickstart)>CLOCKSWITCH_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}#ifdefined(RCC_PLLSAI2_SUPPORT)CLEAR_BIT(RCC->CR,RCC_CR_HSEON|RCC_CR_HSION|RCC_CR_HSIKERON|RCC_CR_HSIASFS|RCC_CR_PLLON|RCC_CR_PLLSAI1ON|RCC_CR_PLLSAI2ON);#elifdefined(RCC_PLLSAI1_SUPPORT)CLEAR_BIT(RCC->CR,RCC_CR_HSEON|RCC_CR_HSION|RCC_CR_HSIKERON|RCC_CR_HSIASFS|RCC_CR_PLLON|RCC_CR_PLLSAI1ON);#elseCLEAR_BIT(RCC->CR,RCC_CR_HSEON|RCC_CR_HSION|RCC_CR_HSIKERON|RCC_CR_HSIASFS|RCC_CR_PLLON);#endiftickstart=HAL_GetTick();#ifdefined(RCC_PLLSAI2_SUPPORT)while(READ_BIT(RCC->CR,RCC_CR_PLLRDY|RCC_CR_PLLSAI1RDY|RCC_CR_PLLSAI2RDY)!=0U)#elifdefined(RCC_PLLSAI1_SUPPORT)while(READ_BIT(RCC->CR,RCC_CR_PLLRDY|RCC_CR_PLLSAI1RDY)!=0U)#elsewhile(READ_BIT(RCC->CR,RCC_CR_PLLRDY)!=0U)#endif{if((HAL_GetTick()-tickstart)>PLL_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}CLEAR_REG(RCC->PLLCFGR);SET_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLN_4);#ifdefined(RCC_PLLSAI1_SUPPORT)CLEAR_REG(RCC->PLLSAI1CFGR);SET_BIT(RCC->PLLSAI1CFGR,RCC_PLLSAI1CFGR_PLLSAI1N_4);#endif#ifdefined(RCC_PLLSAI2_SUPPORT)CLEAR_REG(RCC->PLLSAI2CFGR);SET_BIT(RCC->PLLSAI2CFGR,RCC_PLLSAI2CFGR_PLLSAI2N_4);#endifCLEAR_BIT(RCC->CR,RCC_CR_HSEBYP);CLEAR_REG(RCC->CIER);WRITE_REG(RCC->CICR,0xFFFFFFFFU);SET_BIT(RCC->CSR,RCC_CSR_RMVF);returnHAL_OK;}HAL_StatusTypeDefHAL_RCC_OscConfig(RCC_OscInitTypeDef*RCC_OscInitStruct){uint32_ttickstart;HAL_StatusTypeDefstatus;uint32_tsysclk_source,pll_config;if(RCC_OscInitStruct==NULL){returnHAL_ERROR;}assert_param(IS_RCC_OSCILLATORTYPE(RCC_OscInitStruct->OscillatorType));sysclk_source=__HAL_RCC_GET_SYSCLK_SOURCE();pll_config=__HAL_RCC_GET_PLL_OSCSOURCE();if(((RCC_OscInitStruct->OscillatorType)&RCC_OSCILLATORTYPE_MSI)==RCC_OSCILLATORTYPE_MSI){assert_param(IS_RCC_MSI(RCC_OscInitStruct->MSIState));assert_param(IS_RCC_MSICALIBRATION_VALUE(RCC_OscInitStruct->MSICalibrationValue));assert_param(IS_RCC_MSI_CLOCK_RANGE(RCC_OscInitStruct->MSIClockRange));if((sysclk_source==RCC_CFGR_SWS_MSI)||((sysclk_source==RCC_CFGR_SWS_PLL)&&(pll_config==RCC_PLLSOURCE_MSI))){if((READ_BIT(RCC->CR,RCC_CR_MSIRDY)!=0U)&&(RCC_OscInitStruct->MSIState==RCC_MSI_OFF)){returnHAL_ERROR;}else{if(RCC_OscInitStruct->MSIClockRange>__HAL_RCC_GET_MSI_RANGE()){if(RCC_SetFlashLatencyFromMSIRange(RCC_OscInitStruct->MSIClockRange)!=HAL_OK){returnHAL_ERROR;}__HAL_RCC_MSI_RANGE_CONFIG(RCC_OscInitStruct->MSIClockRange);__HAL_RCC_MSI_CALIBRATIONVALUE_ADJUST(RCC_OscInitStruct->MSICalibrationValue);}else{__HAL_RCC_MSI_RANGE_CONFIG(RCC_OscInitStruct->MSIClockRange);__HAL_RCC_MSI_CALIBRATIONVALUE_ADJUST(RCC_OscInitStruct->MSICalibrationValue);if(sysclk_source==RCC_CFGR_SWS_MSI){if(RCC_SetFlashLatencyFromMSIRange(RCC_OscInitStruct->MSIClockRange)!=HAL_OK){returnHAL_ERROR;}}}SystemCoreClock=HAL_RCC_GetSysClockFreq()>>(AHBPrescTable[READ_BIT(RCC->CFGR,RCC_CFGR_HPRE)>>RCC_CFGR_HPRE_Pos]&0x1FU);status=HAL_InitTick(uwTickPrio);if(status!=HAL_OK){returnstatus;}}}else{if(RCC_OscInitStruct->MSIState!=RCC_MSI_OFF){__HAL_RCC_MSI_ENABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_MSIRDY)==0U){if((HAL_GetTick()-tickstart)>MSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}__HAL_RCC_MSI_RANGE_CONFIG(RCC_OscInitStruct->MSIClockRange);__HAL_RCC_MSI_CALIBRATIONVALUE_ADJUST(RCC_OscInitStruct->MSICalibrationValue);}else{__HAL_RCC_MSI_DISABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_MSIRDY)!=0U){if((HAL_GetTick()-tickstart)>MSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}}}if(((RCC_OscInitStruct->OscillatorType)&RCC_OSCILLATORTYPE_HSE)==RCC_OSCILLATORTYPE_HSE){assert_param(IS_RCC_HSE(RCC_OscInitStruct->HSEState));if((sysclk_source==RCC_CFGR_SWS_HSE)||((sysclk_source==RCC_CFGR_SWS_PLL)&&(pll_config==RCC_PLLSOURCE_HSE))){if((READ_BIT(RCC->CR,RCC_CR_HSERDY)!=0U)&&(RCC_OscInitStruct->HSEState==RCC_HSE_OFF)){returnHAL_ERROR;}}else{__HAL_RCC_HSE_CONFIG(RCC_OscInitStruct->HSEState);if(RCC_OscInitStruct->HSEState!=RCC_HSE_OFF){tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_HSERDY)==0U){if((HAL_GetTick()-tickstart)>HSE_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}else{tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_HSERDY)!=0U){if((HAL_GetTick()-tickstart)>HSE_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}}}if(((RCC_OscInitStruct->OscillatorType)&RCC_OSCILLATORTYPE_HSI)==RCC_OSCILLATORTYPE_HSI){assert_param(IS_RCC_HSI(RCC_OscInitStruct->HSIState));assert_param(IS_RCC_HSI_CALIBRATION_VALUE(RCC_OscInitStruct->HSICalibrationValue));if((sysclk_source==RCC_CFGR_SWS_HSI)||((sysclk_source==RCC_CFGR_SWS_PLL)&&(pll_config==RCC_PLLSOURCE_HSI))){if((READ_BIT(RCC->CR,RCC_CR_HSIRDY)!=0U)&&(RCC_OscInitStruct->HSIState==RCC_HSI_OFF)){returnHAL_ERROR;}else{__HAL_RCC_HSI_CALIBRATIONVALUE_ADJUST(RCC_OscInitStruct->HSICalibrationValue);}}else{if(RCC_OscInitStruct->HSIState!=RCC_HSI_OFF){__HAL_RCC_HSI_ENABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_HSIRDY)==0U){if((HAL_GetTick()-tickstart)>HSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}__HAL_RCC_HSI_CALIBRATIONVALUE_ADJUST(RCC_OscInitStruct->HSICalibrationValue);}else{__HAL_RCC_HSI_DISABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_HSIRDY)!=0U){if((HAL_GetTick()-tickstart)>HSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}}}if(((RCC_OscInitStruct->OscillatorType)&RCC_OSCILLATORTYPE_LSI)==RCC_OSCILLATORTYPE_LSI){assert_param(IS_RCC_LSI(RCC_OscInitStruct->LSIState));if(RCC_OscInitStruct->LSIState!=RCC_LSI_OFF){#ifdefined(RCC_CSR_LSIPREDIV)uint32_tcsr_temp=RCC->CSR;assert_param(IS_RCC_LSIDIV(RCC_OscInitStruct->LSIDiv));if(RCC_OscInitStruct->LSIDiv!=(csr_temp&RCC_CSR_LSIPREDIV)){if(((csr_temp&RCC_CSR_LSIRDY)==RCC_CSR_LSIRDY)&&\((csr_temp&RCC_CSR_LSION)!=RCC_CSR_LSION)){returnHAL_ERROR;}if((csr_temp&RCC_CSR_LSION)==RCC_CSR_LSION){__HAL_RCC_LSI_DISABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CSR,RCC_CSR_LSIRDY)!=0U){if((HAL_GetTick()-tickstart)>LSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}MODIFY_REG(RCC->CSR,RCC_CSR_LSIPREDIV,RCC_OscInitStruct->LSIDiv);}#endif__HAL_RCC_LSI_ENABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CSR,RCC_CSR_LSIRDY)==0U){if((HAL_GetTick()-tickstart)>LSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}else{__HAL_RCC_LSI_DISABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CSR,RCC_CSR_LSIRDY)!=0U){if((HAL_GetTick()-tickstart)>LSI_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}}if(((RCC_OscInitStruct->OscillatorType)&RCC_OSCILLATORTYPE_LSE)==RCC_OSCILLATORTYPE_LSE){FlagStatuspwrclkchanged=RESET;assert_param(IS_RCC_LSE(RCC_OscInitStruct->LSEState));if(HAL_IS_BIT_CLR(RCC->APB1ENR1,RCC_APB1ENR1_PWREN)){__HAL_RCC_PWR_CLK_ENABLE();pwrclkchanged=SET;}if(HAL_IS_BIT_CLR(PWR->CR1,PWR_CR1_DBP)){SET_BIT(PWR->CR1,PWR_CR1_DBP);tickstart=HAL_GetTick();while(HAL_IS_BIT_CLR(PWR->CR1,PWR_CR1_DBP)){if((HAL_GetTick()-tickstart)>RCC_DBP_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}#ifdefined(RCC_BDCR_LSESYSDIS)if((RCC_OscInitStruct->LSEState&RCC_BDCR_LSEON)!=0U){MODIFY_REG(RCC->BDCR,RCC_BDCR_LSESYSDIS,(RCC_OscInitStruct->LSEState&RCC_BDCR_LSESYSDIS));if((RCC_OscInitStruct->LSEState&RCC_BDCR_LSEBYP)!=0U){SET_BIT(RCC->BDCR,RCC_BDCR_LSEBYP);SET_BIT(RCC->BDCR,RCC_BDCR_LSEON);}else{SET_BIT(RCC->BDCR,RCC_BDCR_LSEON);}}else{CLEAR_BIT(RCC->BDCR,RCC_BDCR_LSEON);CLEAR_BIT(RCC->BDCR,RCC_BDCR_LSEBYP);}#else__HAL_RCC_LSE_CONFIG(RCC_OscInitStruct->LSEState);#endifif(RCC_OscInitStruct->LSEState!=RCC_LSE_OFF){tickstart=HAL_GetTick();while(READ_BIT(RCC->BDCR,RCC_BDCR_LSERDY)==0U){if((HAL_GetTick()-tickstart)>RCC_LSE_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}else{tickstart=HAL_GetTick();while(READ_BIT(RCC->BDCR,RCC_BDCR_LSERDY)!=0U){if((HAL_GetTick()-tickstart)>RCC_LSE_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}#ifdefined(RCC_BDCR_LSESYSDIS)CLEAR_BIT(RCC->BDCR,RCC_BDCR_LSESYSDIS);#endif}if(pwrclkchanged==SET){__HAL_RCC_PWR_CLK_DISABLE();}}#ifdefined(RCC_HSI48_SUPPORT)if(((RCC_OscInitStruct->OscillatorType)&RCC_OSCILLATORTYPE_HSI48)==RCC_OSCILLATORTYPE_HSI48){assert_param(IS_RCC_HSI48(RCC_OscInitStruct->HSI48State));if(RCC_OscInitStruct->HSI48State!=RCC_HSI48_OFF){__HAL_RCC_HSI48_ENABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CRRCR,RCC_CRRCR_HSI48RDY)==0U){if((HAL_GetTick()-tickstart)>HSI48_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}else{__HAL_RCC_HSI48_DISABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CRRCR,RCC_CRRCR_HSI48RDY)!=0U){if((HAL_GetTick()-tickstart)>HSI48_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}}#endifassert_param(IS_RCC_PLL(RCC_OscInitStruct->PLL.PLLState));if(RCC_OscInitStruct->PLL.PLLState!=RCC_PLL_NONE){if(RCC_OscInitStruct->PLL.PLLState==RCC_PLL_ON){assert_param(IS_RCC_PLLSOURCE(RCC_OscInitStruct->PLL.PLLSource));assert_param(IS_RCC_PLLM_VALUE(RCC_OscInitStruct->PLL.PLLM));assert_param(IS_RCC_PLLN_VALUE(RCC_OscInitStruct->PLL.PLLN));#ifdefined(RCC_PLLP_SUPPORT)assert_param(IS_RCC_PLLP_VALUE(RCC_OscInitStruct->PLL.PLLP));#endifassert_param(IS_RCC_PLLQ_VALUE(RCC_OscInitStruct->PLL.PLLQ));assert_param(IS_RCC_PLLR_VALUE(RCC_OscInitStruct->PLL.PLLR));pll_config=RCC->PLLCFGR;if((READ_BIT(pll_config,RCC_PLLCFGR_PLLSRC)!=RCC_OscInitStruct->PLL.PLLSource)||(READ_BIT(pll_config,RCC_PLLCFGR_PLLM)!=((RCC_OscInitStruct->PLL.PLLM-1U)<<RCC_PLLCFGR_PLLM_Pos))||(READ_BIT(pll_config,RCC_PLLCFGR_PLLN)!=(RCC_OscInitStruct->PLL.PLLN<<RCC_PLLCFGR_PLLN_Pos))||#ifdefined(RCC_PLLP_SUPPORT)#ifdefined(RCC_PLLP_DIV_2_31_SUPPORT)(READ_BIT(pll_config,RCC_PLLCFGR_PLLPDIV)!=(RCC_OscInitStruct->PLL.PLLP<<RCC_PLLCFGR_PLLPDIV_Pos))||#else(READ_BIT(pll_config,RCC_PLLCFGR_PLLP)!=((RCC_OscInitStruct->PLL.PLLP==RCC_PLLP_DIV7)?0U:1U))||#endif#endif(READ_BIT(pll_config,RCC_PLLCFGR_PLLQ)!=((((RCC_OscInitStruct->PLL.PLLQ)>>1U)-1U)<<RCC_PLLCFGR_PLLQ_Pos))||(READ_BIT(pll_config,RCC_PLLCFGR_PLLR)!=((((RCC_OscInitStruct->PLL.PLLR)>>1U)-1U)<<RCC_PLLCFGR_PLLR_Pos))){if(sysclk_source!=RCC_CFGR_SWS_PLL){#ifdefined(RCC_PLLSAI1_SUPPORT)||defined(RCC_PLLSAI2_SUPPORT)if((READ_BIT(RCC->CR,RCC_CR_PLLSAI1ON)!=0U)#ifdefined(RCC_PLLSAI2_SUPPORT)||(READ_BIT(RCC->CR,RCC_CR_PLLSAI2ON)!=0U)#endif){returnHAL_ERROR;}else#endif{__HAL_RCC_PLL_DISABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_PLLRDY)!=0U){if((HAL_GetTick()-tickstart)>PLL_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}#ifdefined(RCC_PLLP_SUPPORT)__HAL_RCC_PLL_CONFIG(RCC_OscInitStruct->PLL.PLLSource,RCC_OscInitStruct->PLL.PLLM,RCC_OscInitStruct->PLL.PLLN,RCC_OscInitStruct->PLL.PLLP,RCC_OscInitStruct->PLL.PLLQ,RCC_OscInitStruct->PLL.PLLR);#else__HAL_RCC_PLL_CONFIG(RCC_OscInitStruct->PLL.PLLSource,RCC_OscInitStruct->PLL.PLLM,RCC_OscInitStruct->PLL.PLLN,RCC_OscInitStruct->PLL.PLLQ,RCC_OscInitStruct->PLL.PLLR);#endif__HAL_RCC_PLL_ENABLE();__HAL_RCC_PLLCLKOUT_ENABLE(RCC_PLL_SYSCLK);tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_PLLRDY)==0U){if((HAL_GetTick()-tickstart)>PLL_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}}else{returnHAL_ERROR;}}else{if(READ_BIT(RCC->CR,RCC_CR_PLLRDY)==0U){__HAL_RCC_PLL_ENABLE();__HAL_RCC_PLLCLKOUT_ENABLE(RCC_PLL_SYSCLK);tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_PLLRDY)==0U){if((HAL_GetTick()-tickstart)>PLL_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}}}else{if(sysclk_source!=RCC_CFGR_SWS_PLL){__HAL_RCC_PLL_DISABLE();tickstart=HAL_GetTick();while(READ_BIT(RCC->CR,RCC_CR_PLLRDY)!=0U){if((HAL_GetTick()-tickstart)>PLL_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}#ifdefined(RCC_PLLSAI2_SUPPORT)RCC->PLLCFGR&=~(RCC_PLLCFGR_PLLSRC|RCC_PLL_SYSCLK|RCC_PLL_48M1CLK|RCC_PLL_SAI3CLK);#elifdefined(RCC_PLLSAI1_SUPPORT)RCC->PLLCFGR&=~(RCC_PLLCFGR_PLLSRC|RCC_PLL_SYSCLK|RCC_PLL_48M1CLK|RCC_PLL_SAI2CLK);#elseRCC->PLLCFGR&=~(RCC_PLLCFGR_PLLSRC|RCC_PLL_SYSCLK|RCC_PLL_48M1CLK);#endif}else{returnHAL_ERROR;}}}returnHAL_OK;}HAL_StatusTypeDefHAL_RCC_ClockConfig(RCC_ClkInitTypeDef*RCC_ClkInitStruct,uint32_tFLatency){uint32_ttickstart;#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)uint32_thpre=RCC_SYSCLK_DIV1;#endifHAL_StatusTypeDefstatus;if(RCC_ClkInitStruct==NULL){returnHAL_ERROR;}assert_param(IS_RCC_CLOCKTYPE(RCC_ClkInitStruct->ClockType));assert_param(IS_FLASH_LATENCY(FLatency));if(FLatency>__HAL_FLASH_GET_LATENCY()){__HAL_FLASH_SET_LATENCY(FLatency);if(__HAL_FLASH_GET_LATENCY()!=FLatency){returnHAL_ERROR;}}if(((RCC_ClkInitStruct->ClockType)&RCC_CLOCKTYPE_HCLK)==RCC_CLOCKTYPE_HCLK){assert_param(IS_RCC_HCLK(RCC_ClkInitStruct->AHBCLKDivider));if(RCC_ClkInitStruct->AHBCLKDivider>READ_BIT(RCC->CFGR,RCC_CFGR_HPRE)){MODIFY_REG(RCC->CFGR,RCC_CFGR_HPRE,RCC_ClkInitStruct->AHBCLKDivider);}}if(((RCC_ClkInitStruct->ClockType)&RCC_CLOCKTYPE_SYSCLK)==RCC_CLOCKTYPE_SYSCLK){assert_param(IS_RCC_SYSCLKSOURCE(RCC_ClkInitStruct->SYSCLKSource));if(RCC_ClkInitStruct->SYSCLKSource==RCC_SYSCLKSOURCE_PLLCLK){if(READ_BIT(RCC->CR,RCC_CR_PLLRDY)==0U){returnHAL_ERROR;}#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)if(RCC_GetSysClockFreqFromPLLSource()>80000000U){if(READ_BIT(RCC->CFGR,RCC_CFGR_HPRE)==RCC_SYSCLK_DIV1){MODIFY_REG(RCC->CFGR,RCC_CFGR_HPRE,RCC_SYSCLK_DIV2);hpre=RCC_SYSCLK_DIV2;}}#endif}else{if(RCC_ClkInitStruct->SYSCLKSource==RCC_SYSCLKSOURCE_HSE){if(READ_BIT(RCC->CR,RCC_CR_HSERDY)==0U){returnHAL_ERROR;}}elseif(RCC_ClkInitStruct->SYSCLKSource==RCC_SYSCLKSOURCE_MSI){if(READ_BIT(RCC->CR,RCC_CR_MSIRDY)==0U){returnHAL_ERROR;}}else{if(READ_BIT(RCC->CR,RCC_CR_HSIRDY)==0U){returnHAL_ERROR;}}#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)if(HAL_RCC_GetSysClockFreq()>80000000U){if(READ_BIT(RCC->CFGR,RCC_CFGR_HPRE)==RCC_SYSCLK_DIV1){MODIFY_REG(RCC->CFGR,RCC_CFGR_HPRE,RCC_SYSCLK_DIV2);hpre=RCC_SYSCLK_DIV2;}}#endif}MODIFY_REG(RCC->CFGR,RCC_CFGR_SW,RCC_ClkInitStruct->SYSCLKSource);tickstart=HAL_GetTick();while(__HAL_RCC_GET_SYSCLK_SOURCE()!=(RCC_ClkInitStruct->SYSCLKSource<<RCC_CFGR_SWS_Pos)){if((HAL_GetTick()-tickstart)>CLOCKSWITCH_TIMEOUT_VALUE){returnHAL_TIMEOUT;}}}#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)if(hpre==RCC_SYSCLK_DIV2){MODIFY_REG(RCC->CFGR,RCC_CFGR_HPRE,RCC_SYSCLK_DIV1);}#endifif(((RCC_ClkInitStruct->ClockType)&RCC_CLOCKTYPE_HCLK)==RCC_CLOCKTYPE_HCLK){if(RCC_ClkInitStruct->AHBCLKDivider<READ_BIT(RCC->CFGR,RCC_CFGR_HPRE)){MODIFY_REG(RCC->CFGR,RCC_CFGR_HPRE,RCC_ClkInitStruct->AHBCLKDivider);}}if(FLatency<__HAL_FLASH_GET_LATENCY()){__HAL_FLASH_SET_LATENCY(FLatency);if(__HAL_FLASH_GET_LATENCY()!=FLatency){returnHAL_ERROR;}}if(((RCC_ClkInitStruct->ClockType)&RCC_CLOCKTYPE_PCLK1)==RCC_CLOCKTYPE_PCLK1){assert_param(IS_RCC_PCLK(RCC_ClkInitStruct->APB1CLKDivider));MODIFY_REG(RCC->CFGR,RCC_CFGR_PPRE1,RCC_ClkInitStruct->APB1CLKDivider);}if(((RCC_ClkInitStruct->ClockType)&RCC_CLOCKTYPE_PCLK2)==RCC_CLOCKTYPE_PCLK2){assert_param(IS_RCC_PCLK(RCC_ClkInitStruct->APB2CLKDivider));MODIFY_REG(RCC->CFGR,RCC_CFGR_PPRE2,((RCC_ClkInitStruct->APB2CLKDivider)<<3U));}SystemCoreClock=HAL_RCC_GetSysClockFreq()>>(AHBPrescTable[READ_BIT(RCC->CFGR,RCC_CFGR_HPRE)>>RCC_CFGR_HPRE_Pos]&0x1FU);status=HAL_InitTick(uwTickPrio);returnstatus;}voidHAL_RCC_MCOConfig(uint32_tRCC_MCOx,uint32_tRCC_MCOSource,uint32_tRCC_MCODiv){GPIO_InitTypeDefGPIO_InitStruct;assert_param(IS_RCC_MCO(RCC_MCOx));assert_param(IS_RCC_MCODIV(RCC_MCODiv));assert_param(IS_RCC_MCO1SOURCE(RCC_MCOSource));UNUSED(RCC_MCOx);__MCO1_CLK_ENABLE();GPIO_InitStruct.Pin=MCO1_PIN;GPIO_InitStruct.Mode=GPIO_MODE_AF_PP;GPIO_InitStruct.Speed=GPIO_SPEED_FREQ_HIGH;GPIO_InitStruct.Pull=GPIO_NOPULL;GPIO_InitStruct.Alternate=GPIO_AF0_MCO;HAL_GPIO_Init(MCO1_GPIO_PORT,&GPIO_InitStruct);MODIFY_REG(RCC->CFGR,(RCC_CFGR_MCOSEL|RCC_CFGR_MCOPRE),(RCC_MCOSource|RCC_MCODiv));}uint32_tHAL_RCC_GetSysClockFreq(void){uint32_tmsirange=0U,sysclockfreq=0U;uint32_tpllvco,pllsource,pllr,pllm;uint32_tsysclk_source,pll_oscsource;sysclk_source=__HAL_RCC_GET_SYSCLK_SOURCE();pll_oscsource=__HAL_RCC_GET_PLL_OSCSOURCE();if((sysclk_source==RCC_CFGR_SWS_MSI)||((sysclk_source==RCC_CFGR_SWS_PLL)&&(pll_oscsource==RCC_PLLSOURCE_MSI))){if(READ_BIT(RCC->CR,RCC_CR_MSIRGSEL)==0U){msirange=READ_BIT(RCC->CSR,RCC_CSR_MSISRANGE)>>RCC_CSR_MSISRANGE_Pos;}else{msirange=READ_BIT(RCC->CR,RCC_CR_MSIRANGE)>>RCC_CR_MSIRANGE_Pos;}msirange=MSIRangeTable[msirange];if(sysclk_source==RCC_CFGR_SWS_MSI){sysclockfreq=msirange;}}elseif(sysclk_source==RCC_CFGR_SWS_HSI){sysclockfreq=HSI_VALUE;}elseif(sysclk_source==RCC_CFGR_SWS_HSE){sysclockfreq=HSE_VALUE;}else{}if(sysclk_source==RCC_CFGR_SWS_PLL){pllsource=READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLSRC);switch(pllsource){caseRCC_PLLSOURCE_HSI:pllvco=HSI_VALUE;break;caseRCC_PLLSOURCE_HSE:pllvco=HSE_VALUE;break;caseRCC_PLLSOURCE_MSI:default:pllvco=msirange;break;}pllm=(READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLM)>>RCC_PLLCFGR_PLLM_Pos)+1U;pllvco=(pllvco*(READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLN)>>RCC_PLLCFGR_PLLN_Pos))/pllm;pllr=((READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLR)>>RCC_PLLCFGR_PLLR_Pos)+1U)*2U;sysclockfreq=pllvco/pllr;}returnsysclockfreq;}uint32_tHAL_RCC_GetHCLKFreq(void){returnSystemCoreClock;}uint32_tHAL_RCC_GetPCLK1Freq(void){return(HAL_RCC_GetHCLKFreq()>>(APBPrescTable[READ_BIT(RCC->CFGR,RCC_CFGR_PPRE1)>>RCC_CFGR_PPRE1_Pos]&0x1FU));}uint32_tHAL_RCC_GetPCLK2Freq(void){return(HAL_RCC_GetHCLKFreq()>>(APBPrescTable[READ_BIT(RCC->CFGR,RCC_CFGR_PPRE2)>>RCC_CFGR_PPRE2_Pos]&0x1FU));}voidHAL_RCC_GetOscConfig(RCC_OscInitTypeDef*RCC_OscInitStruct){assert_param(RCC_OscInitStruct!=(void*)NULL);#ifdefined(RCC_HSI48_SUPPORT)RCC_OscInitStruct->OscillatorType=RCC_OSCILLATORTYPE_HSE|RCC_OSCILLATORTYPE_HSI|RCC_OSCILLATORTYPE_MSI|\RCC_OSCILLATORTYPE_LSE|RCC_OSCILLATORTYPE_LSI|RCC_OSCILLATORTYPE_HSI48;#elseRCC_OscInitStruct->OscillatorType=RCC_OSCILLATORTYPE_HSE|RCC_OSCILLATORTYPE_HSI|RCC_OSCILLATORTYPE_MSI|\RCC_OSCILLATORTYPE_LSE|RCC_OSCILLATORTYPE_LSI;#endifif(READ_BIT(RCC->CR,RCC_CR_HSEBYP)==RCC_CR_HSEBYP){RCC_OscInitStruct->HSEState=RCC_HSE_BYPASS;}elseif(READ_BIT(RCC->CR,RCC_CR_HSEON)==RCC_CR_HSEON){RCC_OscInitStruct->HSEState=RCC_HSE_ON;}else{RCC_OscInitStruct->HSEState=RCC_HSE_OFF;}if(READ_BIT(RCC->CR,RCC_CR_MSION)==RCC_CR_MSION){RCC_OscInitStruct->MSIState=RCC_MSI_ON;}else{RCC_OscInitStruct->MSIState=RCC_MSI_OFF;}RCC_OscInitStruct->MSICalibrationValue=READ_BIT(RCC->ICSCR,RCC_ICSCR_MSITRIM)>>RCC_ICSCR_MSITRIM_Pos;RCC_OscInitStruct->MSIClockRange=READ_BIT(RCC->CR,RCC_CR_MSIRANGE);if(READ_BIT(RCC->CR,RCC_CR_HSION)==RCC_CR_HSION){RCC_OscInitStruct->HSIState=RCC_HSI_ON;}else{RCC_OscInitStruct->HSIState=RCC_HSI_OFF;}RCC_OscInitStruct->HSICalibrationValue=READ_BIT(RCC->ICSCR,RCC_ICSCR_HSITRIM)>>RCC_ICSCR_HSITRIM_Pos;if(READ_BIT(RCC->BDCR,RCC_BDCR_LSEBYP)==RCC_BDCR_LSEBYP){#ifdefined(RCC_BDCR_LSESYSDIS)if((RCC->BDCR&RCC_BDCR_LSESYSDIS)==RCC_BDCR_LSESYSDIS){RCC_OscInitStruct->LSEState=RCC_LSE_BYPASS_RTC_ONLY;}else#endif{RCC_OscInitStruct->LSEState=RCC_LSE_BYPASS;}}elseif(READ_BIT(RCC->BDCR,RCC_BDCR_LSEON)==RCC_BDCR_LSEON){#ifdefined(RCC_BDCR_LSESYSDIS)if((RCC->BDCR&RCC_BDCR_LSESYSDIS)==RCC_BDCR_LSESYSDIS){RCC_OscInitStruct->LSEState=RCC_LSE_ON_RTC_ONLY;}else#endif{RCC_OscInitStruct->LSEState=RCC_LSE_ON;}}else{RCC_OscInitStruct->LSEState=RCC_LSE_OFF;}if(READ_BIT(RCC->CSR,RCC_CSR_LSION)==RCC_CSR_LSION){RCC_OscInitStruct->LSIState=RCC_LSI_ON;}else{RCC_OscInitStruct->LSIState=RCC_LSI_OFF;}#ifdefined(RCC_CSR_LSIPREDIV)if((RCC->CSR&RCC_CSR_LSIPREDIV)==RCC_CSR_LSIPREDIV){RCC_OscInitStruct->LSIDiv=RCC_LSI_DIV128;}else{RCC_OscInitStruct->LSIDiv=RCC_LSI_DIV1;}#endif#ifdefined(RCC_HSI48_SUPPORT)if(READ_BIT(RCC->CRRCR,RCC_CRRCR_HSI48ON)==RCC_CRRCR_HSI48ON){RCC_OscInitStruct->HSI48State=RCC_HSI48_ON;}else{RCC_OscInitStruct->HSI48State=RCC_HSI48_OFF;}#elseRCC_OscInitStruct->HSI48State=RCC_HSI48_OFF;#endifif(READ_BIT(RCC->CR,RCC_CR_PLLON)==RCC_CR_PLLON){RCC_OscInitStruct->PLL.PLLState=RCC_PLL_ON;}else{RCC_OscInitStruct->PLL.PLLState=RCC_PLL_OFF;}RCC_OscInitStruct->PLL.PLLSource=READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLSRC);RCC_OscInitStruct->PLL.PLLM=(READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLM)>>RCC_PLLCFGR_PLLM_Pos)+1U;RCC_OscInitStruct->PLL.PLLN=READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLN)>>RCC_PLLCFGR_PLLN_Pos;RCC_OscInitStruct->PLL.PLLQ=(((READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLQ)>>RCC_PLLCFGR_PLLQ_Pos)+1U)<<1U);RCC_OscInitStruct->PLL.PLLR=(((READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLR)>>RCC_PLLCFGR_PLLR_Pos)+1U)<<1U);#ifdefined(RCC_PLLP_SUPPORT)#ifdefined(RCC_PLLP_DIV_2_31_SUPPORT)RCC_OscInitStruct->PLL.PLLP=READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLPDIV)>>RCC_PLLCFGR_PLLPDIV_Pos;#elseif(READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLP)!=0U){RCC_OscInitStruct->PLL.PLLP=RCC_PLLP_DIV17;}else{RCC_OscInitStruct->PLL.PLLP=RCC_PLLP_DIV7;}#endif#endif}voidHAL_RCC_GetClockConfig(RCC_ClkInitTypeDef*RCC_ClkInitStruct,uint32_t*pFLatency){assert_param(RCC_ClkInitStruct!=(void*)NULL);assert_param(pFLatency!=(void*)NULL);RCC_ClkInitStruct->ClockType=RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;RCC_ClkInitStruct->SYSCLKSource=READ_BIT(RCC->CFGR,RCC_CFGR_SW);RCC_ClkInitStruct->AHBCLKDivider=READ_BIT(RCC->CFGR,RCC_CFGR_HPRE);RCC_ClkInitStruct->APB1CLKDivider=READ_BIT(RCC->CFGR,RCC_CFGR_PPRE1);RCC_ClkInitStruct->APB2CLKDivider=(READ_BIT(RCC->CFGR,RCC_CFGR_PPRE2)>>3U);*pFLatency=__HAL_FLASH_GET_LATENCY();}voidHAL_RCC_EnableCSS(void){SET_BIT(RCC->CR,RCC_CR_CSSON);}voidHAL_RCC_NMI_IRQHandler(void){if(__HAL_RCC_GET_IT(RCC_IT_CSS)){HAL_RCC_CSSCallback();__HAL_RCC_CLEAR_IT(RCC_IT_CSS);}}__weakvoidHAL_RCC_CSSCallback(void){}uint32_tHAL_RCC_GetResetSource(void){uint32_treset;reset=RCC->CSR&RCC_RESET_FLAG_ALL;RCC->CSR|=RCC_CSR_RMVF;returnreset;}staticHAL_StatusTypeDefRCC_SetFlashLatencyFromMSIRange(uint32_tmsirange){uint32_tvos;uint32_tlatency=FLASH_LATENCY_0;if(__HAL_RCC_PWR_IS_CLK_ENABLED()){vos=HAL_PWREx_GetVoltageRange();}else{__HAL_RCC_PWR_CLK_ENABLE();vos=HAL_PWREx_GetVoltageRange();__HAL_RCC_PWR_CLK_DISABLE();}if(vos==PWR_REGULATOR_VOLTAGE_SCALE1){if(msirange>RCC_MSIRANGE_8){if(msirange>RCC_MSIRANGE_10){latency=FLASH_LATENCY_2;}else{latency=FLASH_LATENCY_1;}}}else{#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)if(msirange>=RCC_MSIRANGE_8){latency=FLASH_LATENCY_2;}else{if(msirange==RCC_MSIRANGE_7){latency=FLASH_LATENCY_1;}}#elseif(msirange>RCC_MSIRANGE_8){latency=FLASH_LATENCY_3;}else{if(msirange==RCC_MSIRANGE_8){latency=FLASH_LATENCY_2;}elseif(msirange==RCC_MSIRANGE_7){latency=FLASH_LATENCY_1;}else{}}#endif}__HAL_FLASH_SET_LATENCY(latency);if(__HAL_FLASH_GET_LATENCY()!=latency){returnHAL_ERROR;}returnHAL_OK;}#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)staticuint32_tRCC_GetSysClockFreqFromPLLSource(void){uint32_tmsirange,pllvco,pllsource,pllr,pllm,sysclockfreq;pllsource=READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLSRC);switch(pllsource){caseRCC_PLLSOURCE_HSI:pllvco=HSI_VALUE;break;caseRCC_PLLSOURCE_HSE:pllvco=HSE_VALUE;break;caseRCC_PLLSOURCE_MSI:if(READ_BIT(RCC->CR,RCC_CR_MSIRGSEL)==0U){msirange=READ_BIT(RCC->CSR,RCC_CSR_MSISRANGE)>>RCC_CSR_MSISRANGE_Pos;}else{msirange=READ_BIT(RCC->CR,RCC_CR_MSIRANGE)>>RCC_CR_MSIRANGE_Pos;}pllvco=MSIRangeTable[msirange];break;default:pllvco=0;break;}pllm=(READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLM)>>RCC_PLLCFGR_PLLM_Pos)+1U;pllvco=(pllvco*(READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLN)>>RCC_PLLCFGR_PLLN_Pos))/pllm;pllr=((READ_BIT(RCC->PLLCFGR,RCC_PLLCFGR_PLLR)>>RCC_PLLCFGR_PLLR_Pos)+1U)*2U;sysclockfreq=pllvco/pllr;returnsysclockfreq;}#endif#endif