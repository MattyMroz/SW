#include"stm32l4xx_hal.h"#ifdefHAL_DMA_MODULE_ENABLEDstaticvoidDMA_SetConfig(DMA_HandleTypeDef*hdma,uint32_tSrcAddress,uint32_tDstAddress,uint32_tDataLength);#ifdefined(DMAMUX1)staticvoidDMA_CalcDMAMUXChannelBaseAndMask(DMA_HandleTypeDef*hdma);staticvoidDMA_CalcDMAMUXRequestGenBaseAndMask(DMA_HandleTypeDef*hdma);#endifHAL_StatusTypeDefHAL_DMA_Init(DMA_HandleTypeDef*hdma){uint32_ttmp;if(hdma==NULL){returnHAL_ERROR;}assert_param(IS_DMA_ALL_INSTANCE(hdma->Instance));assert_param(IS_DMA_DIRECTION(hdma->Init.Direction));assert_param(IS_DMA_PERIPHERAL_INC_STATE(hdma->Init.PeriphInc));assert_param(IS_DMA_MEMORY_INC_STATE(hdma->Init.MemInc));assert_param(IS_DMA_PERIPHERAL_DATA_SIZE(hdma->Init.PeriphDataAlignment));assert_param(IS_DMA_MEMORY_DATA_SIZE(hdma->Init.MemDataAlignment));assert_param(IS_DMA_MODE(hdma->Init.Mode));assert_param(IS_DMA_PRIORITY(hdma->Init.Priority));assert_param(IS_DMA_ALL_REQUEST(hdma->Init.Request));if((uint32_t)(hdma->Instance)<(uint32_t)(DMA2_Channel1)){hdma->ChannelIndex=(((uint32_t)hdma->Instance-(uint32_t)DMA1_Channel1)/((uint32_t)DMA1_Channel2-(uint32_t)DMA1_Channel1))<<2U;hdma->DmaBaseAddress=DMA1;}else{hdma->ChannelIndex=(((uint32_t)hdma->Instance-(uint32_t)DMA2_Channel1)/((uint32_t)DMA2_Channel2-(uint32_t)DMA2_Channel1))<<2U;hdma->DmaBaseAddress=DMA2;}hdma->State=HAL_DMA_STATE_BUSY;tmp=hdma->Instance->CCR;tmp&=((uint32_t)~(DMA_CCR_PL|DMA_CCR_MSIZE|DMA_CCR_PSIZE|DMA_CCR_MINC|DMA_CCR_PINC|DMA_CCR_CIRC|DMA_CCR_DIR|DMA_CCR_MEM2MEM));tmp|=hdma->Init.Direction|hdma->Init.PeriphInc|hdma->Init.MemInc|hdma->Init.PeriphDataAlignment|hdma->Init.MemDataAlignment|hdma->Init.Mode|hdma->Init.Priority;hdma->Instance->CCR=tmp;#ifdefined(DMAMUX1)DMA_CalcDMAMUXChannelBaseAndMask(hdma);if(hdma->Init.Direction==DMA_MEMORY_TO_MEMORY){hdma->Init.Request=DMA_REQUEST_MEM2MEM;}hdma->DMAmuxChannel->CCR=(hdma->Init.Request&DMAMUX_CxCR_DMAREQ_ID);hdma->DMAmuxChannelStatus->CFR=hdma->DMAmuxChannelStatusMask;if(((hdma->Init.Request>0U)&&(hdma->Init.Request<=DMA_REQUEST_GENERATOR3))){DMA_CalcDMAMUXRequestGenBaseAndMask(hdma);hdma->DMAmuxRequestGen->RGCR=0U;hdma->DMAmuxRequestGenStatus->RGCFR=hdma->DMAmuxRequestGenStatusMask;}else{hdma->DMAmuxRequestGen=0U;hdma->DMAmuxRequestGenStatus=0U;hdma->DMAmuxRequestGenStatusMask=0U;}#endif#if!defined(DMAMUX1)if(hdma->Init.Direction!=DMA_MEMORY_TO_MEMORY){if(DMA1==hdma->DmaBaseAddress){DMA1_CSELR->CSELR&=~(DMA_CSELR_C1S<<(hdma->ChannelIndex&0x1cU));DMA1_CSELR->CSELR|=(uint32_t)(hdma->Init.Request<<(hdma->ChannelIndex&0x1cU));}else{DMA2_CSELR->CSELR&=~(DMA_CSELR_C1S<<(hdma->ChannelIndex&0x1cU));DMA2_CSELR->CSELR|=(uint32_t)(hdma->Init.Request<<(hdma->ChannelIndex&0x1cU));}}#endifhdma->ErrorCode=HAL_DMA_ERROR_NONE;hdma->State=HAL_DMA_STATE_READY;hdma->Lock=HAL_UNLOCKED;returnHAL_OK;}HAL_StatusTypeDefHAL_DMA_DeInit(DMA_HandleTypeDef*hdma){if(NULL==hdma){returnHAL_ERROR;}assert_param(IS_DMA_ALL_INSTANCE(hdma->Instance));__HAL_DMA_DISABLE(hdma);if((uint32_t)(hdma->Instance)<(uint32_t)(DMA2_Channel1)){hdma->ChannelIndex=(((uint32_t)hdma->Instance-(uint32_t)DMA1_Channel1)/((uint32_t)DMA1_Channel2-(uint32_t)DMA1_Channel1))<<2U;hdma->DmaBaseAddress=DMA1;}else{hdma->ChannelIndex=(((uint32_t)hdma->Instance-(uint32_t)DMA2_Channel1)/((uint32_t)DMA2_Channel2-(uint32_t)DMA2_Channel1))<<2U;hdma->DmaBaseAddress=DMA2;}hdma->Instance->CCR=0U;hdma->DmaBaseAddress->IFCR=(DMA_ISR_GIF1<<(hdma->ChannelIndex&0x1CU));#if!defined(DMAMUX1)if(DMA1==hdma->DmaBaseAddress){DMA1_CSELR->CSELR&=~(DMA_CSELR_C1S<<(hdma->ChannelIndex&0x1cU));}else{DMA2_CSELR->CSELR&=~(DMA_CSELR_C1S<<(hdma->ChannelIndex&0x1cU));}#endif#ifdefined(DMAMUX1)DMA_CalcDMAMUXChannelBaseAndMask(hdma);hdma->DMAmuxChannel->CCR=0U;hdma->DMAmuxChannelStatus->CFR=hdma->DMAmuxChannelStatusMask;if(((hdma->Init.Request>0U)&&(hdma->Init.Request<=DMA_REQUEST_GENERATOR3))){DMA_CalcDMAMUXRequestGenBaseAndMask(hdma);hdma->DMAmuxRequestGen->RGCR=0U;hdma->DMAmuxRequestGenStatus->RGCFR=hdma->DMAmuxRequestGenStatusMask;}hdma->DMAmuxRequestGen=0U;hdma->DMAmuxRequestGenStatus=0U;hdma->DMAmuxRequestGenStatusMask=0U;#endifhdma->XferCpltCallback=NULL;hdma->XferHalfCpltCallback=NULL;hdma->XferErrorCallback=NULL;hdma->XferAbortCallback=NULL;hdma->ErrorCode=HAL_DMA_ERROR_NONE;hdma->State=HAL_DMA_STATE_RESET;__HAL_UNLOCK(hdma);returnHAL_OK;}HAL_StatusTypeDefHAL_DMA_Start(DMA_HandleTypeDef*hdma,uint32_tSrcAddress,uint32_tDstAddress,uint32_tDataLength){HAL_StatusTypeDefstatus=HAL_OK;assert_param(IS_DMA_BUFFER_SIZE(DataLength));__HAL_LOCK(hdma);if(HAL_DMA_STATE_READY==hdma->State){hdma->State=HAL_DMA_STATE_BUSY;hdma->ErrorCode=HAL_DMA_ERROR_NONE;__HAL_DMA_DISABLE(hdma);DMA_SetConfig(hdma,SrcAddress,DstAddress,DataLength);__HAL_DMA_ENABLE(hdma);}else{__HAL_UNLOCK(hdma);status=HAL_BUSY;}returnstatus;}HAL_StatusTypeDefHAL_DMA_Start_IT(DMA_HandleTypeDef*hdma,uint32_tSrcAddress,uint32_tDstAddress,uint32_tDataLength){HAL_StatusTypeDefstatus=HAL_OK;assert_param(IS_DMA_BUFFER_SIZE(DataLength));__HAL_LOCK(hdma);if(HAL_DMA_STATE_READY==hdma->State){hdma->State=HAL_DMA_STATE_BUSY;hdma->ErrorCode=HAL_DMA_ERROR_NONE;__HAL_DMA_DISABLE(hdma);DMA_SetConfig(hdma,SrcAddress,DstAddress,DataLength);if(NULL!=hdma->XferHalfCpltCallback){__HAL_DMA_ENABLE_IT(hdma,(DMA_IT_TC|DMA_IT_HT|DMA_IT_TE));}else{__HAL_DMA_DISABLE_IT(hdma,DMA_IT_HT);__HAL_DMA_ENABLE_IT(hdma,(DMA_IT_TC|DMA_IT_TE));}#ifdefDMAMUX1if((hdma->DMAmuxChannel->CCR&DMAMUX_CxCR_SE)!=0U){hdma->DMAmuxChannel->CCR|=DMAMUX_CxCR_SOIE;}if(hdma->DMAmuxRequestGen!=0U){hdma->DMAmuxRequestGen->RGCR|=DMAMUX_RGxCR_OIE;}#endif__HAL_DMA_ENABLE(hdma);}else{__HAL_UNLOCK(hdma);status=HAL_BUSY;}returnstatus;}HAL_StatusTypeDefHAL_DMA_Abort(DMA_HandleTypeDef*hdma){HAL_StatusTypeDefstatus=HAL_OK;if(hdma->State!=HAL_DMA_STATE_BUSY){hdma->ErrorCode=HAL_DMA_ERROR_NO_XFER;__HAL_UNLOCK(hdma);returnHAL_ERROR;}else{__HAL_DMA_DISABLE_IT(hdma,(DMA_IT_TC|DMA_IT_HT|DMA_IT_TE));#ifdefined(DMAMUX1)hdma->DMAmuxChannel->CCR&=~DMAMUX_CxCR_SOIE;#endif__HAL_DMA_DISABLE(hdma);hdma->DmaBaseAddress->IFCR=(DMA_ISR_GIF1<<(hdma->ChannelIndex&0x1CU));#ifdefined(DMAMUX1)hdma->DMAmuxChannelStatus->CFR=hdma->DMAmuxChannelStatusMask;if(hdma->DMAmuxRequestGen!=0U){hdma->DMAmuxRequestGen->RGCR&=~DMAMUX_RGxCR_OIE;hdma->DMAmuxRequestGenStatus->RGCFR=hdma->DMAmuxRequestGenStatusMask;}#endifhdma->State=HAL_DMA_STATE_READY;__HAL_UNLOCK(hdma);returnstatus;}}HAL_StatusTypeDefHAL_DMA_Abort_IT(DMA_HandleTypeDef*hdma){HAL_StatusTypeDefstatus=HAL_OK;if(HAL_DMA_STATE_BUSY!=hdma->State){hdma->ErrorCode=HAL_DMA_ERROR_NO_XFER;status=HAL_ERROR;}else{__HAL_DMA_DISABLE_IT(hdma,(DMA_IT_TC|DMA_IT_HT|DMA_IT_TE));__HAL_DMA_DISABLE(hdma);#ifdefined(DMAMUX1)hdma->DMAmuxChannel->CCR&=~DMAMUX_CxCR_SOIE;hdma->DmaBaseAddress->IFCR=(DMA_ISR_GIF1<<(hdma->ChannelIndex&0x1CU));hdma->DMAmuxChannelStatus->CFR=hdma->DMAmuxChannelStatusMask;if(hdma->DMAmuxRequestGen!=0U){hdma->DMAmuxRequestGen->RGCR&=~DMAMUX_RGxCR_OIE;hdma->DMAmuxRequestGenStatus->RGCFR=hdma->DMAmuxRequestGenStatusMask;}#elsehdma->DmaBaseAddress->IFCR=(DMA_ISR_GIF1<<(hdma->ChannelIndex&0x1CU));#endifhdma->State=HAL_DMA_STATE_READY;__HAL_UNLOCK(hdma);if(hdma->XferAbortCallback!=NULL){hdma->XferAbortCallback(hdma);}}returnstatus;}HAL_StatusTypeDefHAL_DMA_PollForTransfer(DMA_HandleTypeDef*hdma,HAL_DMA_LevelCompleteTypeDefCompleteLevel,uint32_tTimeout){uint32_ttemp;uint32_ttickstart;if(HAL_DMA_STATE_BUSY!=hdma->State){hdma->ErrorCode=HAL_DMA_ERROR_NO_XFER;__HAL_UNLOCK(hdma);returnHAL_ERROR;}if((hdma->Instance->CCR&DMA_CCR_CIRC)!=0U){hdma->ErrorCode=HAL_DMA_ERROR_NOT_SUPPORTED;returnHAL_ERROR;}if(HAL_DMA_FULL_TRANSFER==CompleteLevel){temp=DMA_FLAG_TC1<<(hdma->ChannelIndex&0x1CU);}else{temp=DMA_FLAG_HT1<<(hdma->ChannelIndex&0x1CU);}tickstart=HAL_GetTick();while((hdma->DmaBaseAddress->ISR&temp)==0U){if((hdma->DmaBaseAddress->ISR&(DMA_FLAG_TE1<<(hdma->ChannelIndex&0x1CU)))!=0U){hdma->DmaBaseAddress->IFCR=(DMA_ISR_GIF1<<(hdma->ChannelIndex&0x1CU));hdma->ErrorCode=HAL_DMA_ERROR_TE;hdma->State=HAL_DMA_STATE_READY;__HAL_UNLOCK(hdma);returnHAL_ERROR;}if(Timeout!=HAL_MAX_DELAY){if(((HAL_GetTick()-tickstart)>Timeout)||(Timeout==0U)){hdma->ErrorCode=HAL_DMA_ERROR_TIMEOUT;hdma->State=HAL_DMA_STATE_READY;__HAL_UNLOCK(hdma);returnHAL_ERROR;}}}#ifdefined(DMAMUX1)if(hdma->DMAmuxRequestGen!=0U){if((hdma->DMAmuxRequestGenStatus->RGSR&hdma->DMAmuxRequestGenStatusMask)!=0U){hdma->DMAmuxRequestGen->RGCR|=DMAMUX_RGxCR_OIE;hdma->DMAmuxRequestGenStatus->RGCFR=hdma->DMAmuxRequestGenStatusMask;hdma->ErrorCode|=HAL_DMA_ERROR_REQGEN;}}if((hdma->DMAmuxChannelStatus->CSR&hdma->DMAmuxChannelStatusMask)!=0U){hdma->DMAmuxChannelStatus->CFR=hdma->DMAmuxChannelStatusMask;hdma->ErrorCode|=HAL_DMA_ERROR_SYNC;}#endifif(HAL_DMA_FULL_TRANSFER==CompleteLevel){hdma->DmaBaseAddress->IFCR=(DMA_FLAG_TC1<<(hdma->ChannelIndex&0x1CU));__HAL_UNLOCK(hdma);hdma->State=HAL_DMA_STATE_READY;}else{hdma->DmaBaseAddress->IFCR=(DMA_FLAG_HT1<<(hdma->ChannelIndex&0x1CU));}returnHAL_OK;}voidHAL_DMA_IRQHandler(DMA_HandleTypeDef*hdma){uint32_tflag_it=hdma->DmaBaseAddress->ISR;uint32_tsource_it=hdma->Instance->CCR;if(((flag_it&(DMA_FLAG_HT1<<(hdma->ChannelIndex&0x1CU)))!=0U)&&((source_it&DMA_IT_HT)!=0U)){if((hdma->Instance->CCR&DMA_CCR_CIRC)==0U){__HAL_DMA_DISABLE_IT(hdma,DMA_IT_HT);}hdma->DmaBaseAddress->IFCR=DMA_ISR_HTIF1<<(hdma->ChannelIndex&0x1CU);if(hdma->XferHalfCpltCallback!=NULL){hdma->XferHalfCpltCallback(hdma);}}elseif(((flag_it&(DMA_FLAG_TC1<<(hdma->ChannelIndex&0x1CU)))!=0U)&&((source_it&DMA_IT_TC)!=0U)){if((hdma->Instance->CCR&DMA_CCR_CIRC)==0U){__HAL_DMA_DISABLE_IT(hdma,DMA_IT_TE|DMA_IT_TC);hdma->State=HAL_DMA_STATE_READY;}hdma->DmaBaseAddress->IFCR=(DMA_ISR_TCIF1<<(hdma->ChannelIndex&0x1CU));__HAL_UNLOCK(hdma);if(hdma->XferCpltCallback!=NULL){hdma->XferCpltCallback(hdma);}}elseif(((flag_it&(DMA_FLAG_TE1<<(hdma->ChannelIndex&0x1CU)))!=0U)&&((source_it&DMA_IT_TE)!=0U)){__HAL_DMA_DISABLE_IT(hdma,(DMA_IT_TC|DMA_IT_HT|DMA_IT_TE));hdma->DmaBaseAddress->IFCR=(DMA_ISR_GIF1<<(hdma->ChannelIndex&0x1CU));hdma->ErrorCode=HAL_DMA_ERROR_TE;hdma->State=HAL_DMA_STATE_READY;__HAL_UNLOCK(hdma);if(hdma->XferErrorCallback!=NULL){hdma->XferErrorCallback(hdma);}}else{}return;}HAL_StatusTypeDefHAL_DMA_RegisterCallback(DMA_HandleTypeDef*hdma,HAL_DMA_CallbackIDTypeDefCallbackID,void(*pCallback)(DMA_HandleTypeDef*_hdma)){HAL_StatusTypeDefstatus=HAL_OK;__HAL_LOCK(hdma);if(HAL_DMA_STATE_READY==hdma->State){switch(CallbackID){caseHAL_DMA_XFER_CPLT_CB_ID:hdma->XferCpltCallback=pCallback;break;caseHAL_DMA_XFER_HALFCPLT_CB_ID:hdma->XferHalfCpltCallback=pCallback;break;caseHAL_DMA_XFER_ERROR_CB_ID:hdma->XferErrorCallback=pCallback;break;caseHAL_DMA_XFER_ABORT_CB_ID:hdma->XferAbortCallback=pCallback;break;default:status=HAL_ERROR;break;}}else{status=HAL_ERROR;}__HAL_UNLOCK(hdma);returnstatus;}HAL_StatusTypeDefHAL_DMA_UnRegisterCallback(DMA_HandleTypeDef*hdma,HAL_DMA_CallbackIDTypeDefCallbackID){HAL_StatusTypeDefstatus=HAL_OK;__HAL_LOCK(hdma);if(HAL_DMA_STATE_READY==hdma->State){switch(CallbackID){caseHAL_DMA_XFER_CPLT_CB_ID:hdma->XferCpltCallback=NULL;break;caseHAL_DMA_XFER_HALFCPLT_CB_ID:hdma->XferHalfCpltCallback=NULL;break;caseHAL_DMA_XFER_ERROR_CB_ID:hdma->XferErrorCallback=NULL;break;caseHAL_DMA_XFER_ABORT_CB_ID:hdma->XferAbortCallback=NULL;break;caseHAL_DMA_XFER_ALL_CB_ID:hdma->XferCpltCallback=NULL;hdma->XferHalfCpltCallback=NULL;hdma->XferErrorCallback=NULL;hdma->XferAbortCallback=NULL;break;default:status=HAL_ERROR;break;}}else{status=HAL_ERROR;}__HAL_UNLOCK(hdma);returnstatus;}HAL_DMA_StateTypeDefHAL_DMA_GetState(DMA_HandleTypeDef*hdma){returnhdma->State;}uint32_tHAL_DMA_GetError(DMA_HandleTypeDef*hdma){returnhdma->ErrorCode;}staticvoidDMA_SetConfig(DMA_HandleTypeDef*hdma,uint32_tSrcAddress,uint32_tDstAddress,uint32_tDataLength){#ifdefined(DMAMUX1)hdma->DMAmuxChannelStatus->CFR=hdma->DMAmuxChannelStatusMask;if(hdma->DMAmuxRequestGen!=0U){hdma->DMAmuxRequestGenStatus->RGCFR=hdma->DMAmuxRequestGenStatusMask;}#endifhdma->DmaBaseAddress->IFCR=(DMA_ISR_GIF1<<(hdma->ChannelIndex&0x1CU));hdma->Instance->CNDTR=DataLength;if((hdma->Init.Direction)==DMA_MEMORY_TO_PERIPH){hdma->Instance->CPAR=DstAddress;hdma->Instance->CMAR=SrcAddress;}else{hdma->Instance->CPAR=SrcAddress;hdma->Instance->CMAR=DstAddress;}}#ifdefined(DMAMUX1)staticvoidDMA_CalcDMAMUXChannelBaseAndMask(DMA_HandleTypeDef*hdma){uint32_tchannel_number;if((uint32_t)hdma->Instance<(uint32_t)DMA2_Channel1){hdma->DMAmuxChannel=(DMAMUX1_Channel0+(hdma->ChannelIndex>>2U));}else{hdma->DMAmuxChannel=(DMAMUX1_Channel7+(hdma->ChannelIndex>>2U));}channel_number=(((uint32_t)hdma->Instance&0xFFU)-8U)/20U;hdma->DMAmuxChannelStatus=DMAMUX1_ChannelStatus;hdma->DMAmuxChannelStatusMask=1UL<<(channel_number&0x1FU);}staticvoidDMA_CalcDMAMUXRequestGenBaseAndMask(DMA_HandleTypeDef*hdma){uint32_trequest=hdma->Init.Request&DMAMUX_CxCR_DMAREQ_ID;hdma->DMAmuxRequestGen=(DMAMUX_RequestGen_TypeDef*)((uint32_t)(((uint32_t)DMAMUX1_RequestGenerator0)+((request-1U)*4U)));hdma->DMAmuxRequestGenStatus=DMAMUX1_RequestGenStatus;hdma->DMAmuxRequestGenStatusMask=1UL<<((request-1U)&0x3U);}#endif#endif