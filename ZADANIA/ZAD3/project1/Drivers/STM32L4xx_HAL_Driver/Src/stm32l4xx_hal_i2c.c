#include"stm32l4xx_hal.h"#ifdefHAL_I2C_MODULE_ENABLED#defineTIMING_CLEAR_MASK(0xF0FFFFFFU)#defineI2C_TIMEOUT_ADDR(10000U)#defineI2C_TIMEOUT_BUSY(25U)#defineI2C_TIMEOUT_DIR(25U)#defineI2C_TIMEOUT_RXNE(25U)#defineI2C_TIMEOUT_STOPF(25U)#defineI2C_TIMEOUT_TC(25U)#defineI2C_TIMEOUT_TCR(25U)#defineI2C_TIMEOUT_TXIS(25U)#defineI2C_TIMEOUT_FLAG(25U)#defineMAX_NBYTE_SIZE255U#defineSLAVE_ADDR_SHIFT7U#defineSLAVE_ADDR_MSK0x06U#defineI2C_STATE_MSK((uint32_t)((uint32_t)((uint32_t)HAL_I2C_STATE_BUSY_TX|\(uint32_t)HAL_I2C_STATE_BUSY_RX)&\(uint32_t)(~((uint32_t)HAL_I2C_STATE_READY))))#defineI2C_STATE_NONE((uint32_t)(HAL_I2C_MODE_NONE))#defineI2C_STATE_MASTER_BUSY_TX((uint32_t)(((uint32_t)HAL_I2C_STATE_BUSY_TX&I2C_STATE_MSK)|\(uint32_t)HAL_I2C_MODE_MASTER))#defineI2C_STATE_MASTER_BUSY_RX((uint32_t)(((uint32_t)HAL_I2C_STATE_BUSY_RX&I2C_STATE_MSK)|\(uint32_t)HAL_I2C_MODE_MASTER))#defineI2C_STATE_SLAVE_BUSY_TX((uint32_t)(((uint32_t)HAL_I2C_STATE_BUSY_TX&I2C_STATE_MSK)|\(uint32_t)HAL_I2C_MODE_SLAVE))#defineI2C_STATE_SLAVE_BUSY_RX((uint32_t)(((uint32_t)HAL_I2C_STATE_BUSY_RX&I2C_STATE_MSK)|\(uint32_t)HAL_I2C_MODE_SLAVE))#defineI2C_STATE_MEM_BUSY_TX((uint32_t)(((uint32_t)HAL_I2C_STATE_BUSY_TX&I2C_STATE_MSK)|\(uint32_t)HAL_I2C_MODE_MEM))#defineI2C_STATE_MEM_BUSY_RX((uint32_t)(((uint32_t)HAL_I2C_STATE_BUSY_RX&I2C_STATE_MSK)|\(uint32_t)HAL_I2C_MODE_MEM))#defineI2C_XFER_TX_IT(uint16_t)(0x0001U)#defineI2C_XFER_RX_IT(uint16_t)(0x0002U)#defineI2C_XFER_LISTEN_IT(uint16_t)(0x8000U)#defineI2C_XFER_ERROR_IT(uint16_t)(0x0010U)#defineI2C_XFER_CPLT_IT(uint16_t)(0x0020U)#defineI2C_XFER_RELOAD_IT(uint16_t)(0x0040U)#defineI2C_NO_OPTION_FRAME(0xFFFF0000U)#defineI2C_GET_DMA_REMAIN_DATA(__HANDLE__)__HAL_DMA_GET_COUNTER(__HANDLE__)staticvoidI2C_DMAMasterTransmitCplt(DMA_HandleTypeDef*hdma);staticvoidI2C_DMAMasterReceiveCplt(DMA_HandleTypeDef*hdma);staticvoidI2C_DMASlaveTransmitCplt(DMA_HandleTypeDef*hdma);staticvoidI2C_DMASlaveReceiveCplt(DMA_HandleTypeDef*hdma);staticvoidI2C_DMAError(DMA_HandleTypeDef*hdma);staticvoidI2C_DMAAbort(DMA_HandleTypeDef*hdma);staticvoidI2C_ITAddrCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags);staticvoidI2C_ITMasterSeqCplt(I2C_HandleTypeDef*hi2c);staticvoidI2C_ITSlaveSeqCplt(I2C_HandleTypeDef*hi2c);staticvoidI2C_ITMasterCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags);staticvoidI2C_ITSlaveCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags);staticvoidI2C_ITListenCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags);staticvoidI2C_ITError(I2C_HandleTypeDef*hi2c,uint32_tErrorCode);staticHAL_StatusTypeDefI2C_RequestMemoryWrite(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint32_tTimeout,uint32_tTickstart);staticHAL_StatusTypeDefI2C_RequestMemoryRead(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint32_tTimeout,uint32_tTickstart);staticHAL_StatusTypeDefI2C_Master_ISR_IT(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources);staticHAL_StatusTypeDefI2C_Mem_ISR_IT(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources);staticHAL_StatusTypeDefI2C_Slave_ISR_IT(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources);staticHAL_StatusTypeDefI2C_Master_ISR_DMA(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources);staticHAL_StatusTypeDefI2C_Mem_ISR_DMA(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources);staticHAL_StatusTypeDefI2C_Slave_ISR_DMA(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources);staticHAL_StatusTypeDefI2C_WaitOnFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tFlag,FlagStatusStatus,uint32_tTimeout,uint32_tTickstart);staticHAL_StatusTypeDefI2C_WaitOnTXISFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart);staticHAL_StatusTypeDefI2C_WaitOnRXNEFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart);staticHAL_StatusTypeDefI2C_WaitOnSTOPFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart);staticHAL_StatusTypeDefI2C_IsErrorOccurred(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart);staticvoidI2C_Enable_IRQ(I2C_HandleTypeDef*hi2c,uint16_tInterruptRequest);staticvoidI2C_Disable_IRQ(I2C_HandleTypeDef*hi2c,uint16_tInterruptRequest);staticvoidI2C_TreatErrorCallback(I2C_HandleTypeDef*hi2c);staticvoidI2C_Flush_TXDR(I2C_HandleTypeDef*hi2c);staticvoidI2C_TransferConfig(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_tSize,uint32_tMode,uint32_tRequest);staticvoidI2C_ConvertOtherXferOptions(I2C_HandleTypeDef*hi2c);HAL_StatusTypeDefHAL_I2C_Init(I2C_HandleTypeDef*hi2c){if(hi2c==NULL){returnHAL_ERROR;}assert_param(IS_I2C_ALL_INSTANCE(hi2c->Instance));assert_param(IS_I2C_OWN_ADDRESS1(hi2c->Init.OwnAddress1));assert_param(IS_I2C_ADDRESSING_MODE(hi2c->Init.AddressingMode));assert_param(IS_I2C_DUAL_ADDRESS(hi2c->Init.DualAddressMode));assert_param(IS_I2C_OWN_ADDRESS2(hi2c->Init.OwnAddress2));assert_param(IS_I2C_OWN_ADDRESS2_MASK(hi2c->Init.OwnAddress2Masks));assert_param(IS_I2C_GENERAL_CALL(hi2c->Init.GeneralCallMode));assert_param(IS_I2C_NO_STRETCH(hi2c->Init.NoStretchMode));if(hi2c->State==HAL_I2C_STATE_RESET){hi2c->Lock=HAL_UNLOCKED;#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->MasterTxCpltCallback=HAL_I2C_MasterTxCpltCallback;hi2c->MasterRxCpltCallback=HAL_I2C_MasterRxCpltCallback;hi2c->SlaveTxCpltCallback=HAL_I2C_SlaveTxCpltCallback;hi2c->SlaveRxCpltCallback=HAL_I2C_SlaveRxCpltCallback;hi2c->ListenCpltCallback=HAL_I2C_ListenCpltCallback;hi2c->MemTxCpltCallback=HAL_I2C_MemTxCpltCallback;hi2c->MemRxCpltCallback=HAL_I2C_MemRxCpltCallback;hi2c->ErrorCallback=HAL_I2C_ErrorCallback;hi2c->AbortCpltCallback=HAL_I2C_AbortCpltCallback;hi2c->AddrCallback=HAL_I2C_AddrCallback;if(hi2c->MspInitCallback==NULL){hi2c->MspInitCallback=HAL_I2C_MspInit;}hi2c->MspInitCallback(hi2c);#elseHAL_I2C_MspInit(hi2c);#endif}hi2c->State=HAL_I2C_STATE_BUSY;__HAL_I2C_DISABLE(hi2c);hi2c->Instance->TIMINGR=hi2c->Init.Timing&TIMING_CLEAR_MASK;hi2c->Instance->OAR1&=~I2C_OAR1_OA1EN;if(hi2c->Init.AddressingMode==I2C_ADDRESSINGMODE_7BIT){hi2c->Instance->OAR1=(I2C_OAR1_OA1EN|hi2c->Init.OwnAddress1);}else{hi2c->Instance->OAR1=(I2C_OAR1_OA1EN|I2C_OAR1_OA1MODE|hi2c->Init.OwnAddress1);}if(hi2c->Init.AddressingMode==I2C_ADDRESSINGMODE_10BIT){SET_BIT(hi2c->Instance->CR2,I2C_CR2_ADD10);}else{CLEAR_BIT(hi2c->Instance->CR2,I2C_CR2_ADD10);}hi2c->Instance->CR2|=(I2C_CR2_AUTOEND|I2C_CR2_NACK);hi2c->Instance->OAR2&=~I2C_DUALADDRESS_ENABLE;hi2c->Instance->OAR2=(hi2c->Init.DualAddressMode|hi2c->Init.OwnAddress2|\(hi2c->Init.OwnAddress2Masks<<8));hi2c->Instance->CR1=(hi2c->Init.GeneralCallMode|hi2c->Init.NoStretchMode);__HAL_I2C_ENABLE(hi2c);hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_NONE;hi2c->Mode=HAL_I2C_MODE_NONE;returnHAL_OK;}HAL_StatusTypeDefHAL_I2C_DeInit(I2C_HandleTypeDef*hi2c){if(hi2c==NULL){returnHAL_ERROR;}assert_param(IS_I2C_ALL_INSTANCE(hi2c->Instance));hi2c->State=HAL_I2C_STATE_BUSY;__HAL_I2C_DISABLE(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)if(hi2c->MspDeInitCallback==NULL){hi2c->MspDeInitCallback=HAL_I2C_MspDeInit;}hi2c->MspDeInitCallback(hi2c);#elseHAL_I2C_MspDeInit(hi2c);#endifhi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->State=HAL_I2C_STATE_RESET;hi2c->PreviousState=I2C_STATE_NONE;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_OK;}__weakvoidHAL_I2C_MspInit(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_MspDeInit(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)HAL_StatusTypeDefHAL_I2C_RegisterCallback(I2C_HandleTypeDef*hi2c,HAL_I2C_CallbackIDTypeDefCallbackID,pI2C_CallbackTypeDefpCallback){HAL_StatusTypeDefstatus=HAL_OK;if(pCallback==NULL){hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;returnHAL_ERROR;}if(HAL_I2C_STATE_READY==hi2c->State){switch(CallbackID){caseHAL_I2C_MASTER_TX_COMPLETE_CB_ID:hi2c->MasterTxCpltCallback=pCallback;break;caseHAL_I2C_MASTER_RX_COMPLETE_CB_ID:hi2c->MasterRxCpltCallback=pCallback;break;caseHAL_I2C_SLAVE_TX_COMPLETE_CB_ID:hi2c->SlaveTxCpltCallback=pCallback;break;caseHAL_I2C_SLAVE_RX_COMPLETE_CB_ID:hi2c->SlaveRxCpltCallback=pCallback;break;caseHAL_I2C_LISTEN_COMPLETE_CB_ID:hi2c->ListenCpltCallback=pCallback;break;caseHAL_I2C_MEM_TX_COMPLETE_CB_ID:hi2c->MemTxCpltCallback=pCallback;break;caseHAL_I2C_MEM_RX_COMPLETE_CB_ID:hi2c->MemRxCpltCallback=pCallback;break;caseHAL_I2C_ERROR_CB_ID:hi2c->ErrorCallback=pCallback;break;caseHAL_I2C_ABORT_CB_ID:hi2c->AbortCpltCallback=pCallback;break;caseHAL_I2C_MSPINIT_CB_ID:hi2c->MspInitCallback=pCallback;break;caseHAL_I2C_MSPDEINIT_CB_ID:hi2c->MspDeInitCallback=pCallback;break;default:hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;break;}}elseif(HAL_I2C_STATE_RESET==hi2c->State){switch(CallbackID){caseHAL_I2C_MSPINIT_CB_ID:hi2c->MspInitCallback=pCallback;break;caseHAL_I2C_MSPDEINIT_CB_ID:hi2c->MspDeInitCallback=pCallback;break;default:hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;break;}}else{hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;}returnstatus;}HAL_StatusTypeDefHAL_I2C_UnRegisterCallback(I2C_HandleTypeDef*hi2c,HAL_I2C_CallbackIDTypeDefCallbackID){HAL_StatusTypeDefstatus=HAL_OK;if(HAL_I2C_STATE_READY==hi2c->State){switch(CallbackID){caseHAL_I2C_MASTER_TX_COMPLETE_CB_ID:hi2c->MasterTxCpltCallback=HAL_I2C_MasterTxCpltCallback;break;caseHAL_I2C_MASTER_RX_COMPLETE_CB_ID:hi2c->MasterRxCpltCallback=HAL_I2C_MasterRxCpltCallback;break;caseHAL_I2C_SLAVE_TX_COMPLETE_CB_ID:hi2c->SlaveTxCpltCallback=HAL_I2C_SlaveTxCpltCallback;break;caseHAL_I2C_SLAVE_RX_COMPLETE_CB_ID:hi2c->SlaveRxCpltCallback=HAL_I2C_SlaveRxCpltCallback;break;caseHAL_I2C_LISTEN_COMPLETE_CB_ID:hi2c->ListenCpltCallback=HAL_I2C_ListenCpltCallback;break;caseHAL_I2C_MEM_TX_COMPLETE_CB_ID:hi2c->MemTxCpltCallback=HAL_I2C_MemTxCpltCallback;break;caseHAL_I2C_MEM_RX_COMPLETE_CB_ID:hi2c->MemRxCpltCallback=HAL_I2C_MemRxCpltCallback;break;caseHAL_I2C_ERROR_CB_ID:hi2c->ErrorCallback=HAL_I2C_ErrorCallback;break;caseHAL_I2C_ABORT_CB_ID:hi2c->AbortCpltCallback=HAL_I2C_AbortCpltCallback;break;caseHAL_I2C_MSPINIT_CB_ID:hi2c->MspInitCallback=HAL_I2C_MspInit;break;caseHAL_I2C_MSPDEINIT_CB_ID:hi2c->MspDeInitCallback=HAL_I2C_MspDeInit;break;default:hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;break;}}elseif(HAL_I2C_STATE_RESET==hi2c->State){switch(CallbackID){caseHAL_I2C_MSPINIT_CB_ID:hi2c->MspInitCallback=HAL_I2C_MspInit;break;caseHAL_I2C_MSPDEINIT_CB_ID:hi2c->MspDeInitCallback=HAL_I2C_MspDeInit;break;default:hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;break;}}else{hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;}returnstatus;}HAL_StatusTypeDefHAL_I2C_RegisterAddrCallback(I2C_HandleTypeDef*hi2c,pI2C_AddrCallbackTypeDefpCallback){HAL_StatusTypeDefstatus=HAL_OK;if(pCallback==NULL){hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;returnHAL_ERROR;}if(HAL_I2C_STATE_READY==hi2c->State){hi2c->AddrCallback=pCallback;}else{hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;}returnstatus;}HAL_StatusTypeDefHAL_I2C_UnRegisterAddrCallback(I2C_HandleTypeDef*hi2c){HAL_StatusTypeDefstatus=HAL_OK;if(HAL_I2C_STATE_READY==hi2c->State){hi2c->AddrCallback=HAL_I2C_AddrCallback;}else{hi2c->ErrorCode|=HAL_I2C_ERROR_INVALID_CALLBACK;status=HAL_ERROR;}returnstatus;}#endifHAL_StatusTypeDefHAL_I2C_Master_Transmit(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize,uint32_tTimeout){uint32_ttickstart;uint32_txfermode;if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);tickstart=HAL_GetTick();if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_BUSY,SET,I2C_TIMEOUT_BUSY,tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferISR=NULL;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=I2C_AUTOEND_MODE;}if(hi2c->XferSize>0U){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)(hi2c->XferSize+1U),xfermode,I2C_GENERATE_START_WRITE);}else{I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,I2C_GENERATE_START_WRITE);}while(hi2c->XferCount>0U){if(I2C_WaitOnTXISFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;if((hi2c->XferCount!=0U)&&(hi2c->XferSize==0U)){if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_TCR,RESET,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}}}if(I2C_WaitOnSTOPFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);I2C_RESET_CR2(hi2c);hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Receive(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize,uint32_tTimeout){uint32_ttickstart;if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);tickstart=HAL_GetTick();if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_BUSY,SET,I2C_TIMEOUT_BUSY,tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferISR=NULL;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=1U;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_GENERATE_START_READ);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_GENERATE_START_READ);}while(hi2c->XferCount>0U){if(I2C_WaitOnRXNEFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;hi2c->XferSize--;hi2c->XferCount--;if((hi2c->XferCount!=0U)&&(hi2c->XferSize==0U)){if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_TCR,RESET,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}}}if(I2C_WaitOnSTOPFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);I2C_RESET_CR2(hi2c);hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Slave_Transmit(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize,uint32_tTimeout){uint32_ttickstart;uint16_ttmpXferCount;HAL_StatusTypeDeferror;if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}__HAL_LOCK(hi2c);tickstart=HAL_GetTick();hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferISR=NULL;hi2c->Instance->CR2&=~I2C_CR2_NACK;if(hi2c->Init.NoStretchMode==I2C_NOSTRETCH_ENABLE){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;}if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_ADDR,RESET,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;I2C_Flush_TXDR(hi2c);returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);if(hi2c->Init.AddressingMode==I2C_ADDRESSINGMODE_10BIT){if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_ADDR,RESET,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;I2C_Flush_TXDR(hi2c);returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);}if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_DIR,RESET,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;I2C_Flush_TXDR(hi2c);returnHAL_ERROR;}while(hi2c->XferCount>0U){if(I2C_WaitOnTXISFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;}error=I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_AF,RESET,Timeout,tickstart);if(error!=HAL_OK){tmpXferCount=hi2c->XferCount;if((hi2c->ErrorCode==HAL_I2C_ERROR_AF)&&(tmpXferCount==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_NONE;}else{hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}}else{I2C_Flush_TXDR(hi2c);__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);if(I2C_WaitOnSTOPFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);}if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_BUSY,SET,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}hi2c->Instance->CR2|=I2C_CR2_NACK;hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Slave_Receive(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize,uint32_tTimeout){uint32_ttickstart;if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}__HAL_LOCK(hi2c);tickstart=HAL_GetTick();hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferISR=NULL;hi2c->Instance->CR2&=~I2C_CR2_NACK;if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_ADDR,RESET,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_DIR,SET,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}while(hi2c->XferCount>0U){if(I2C_WaitOnRXNEFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_RXNE)==SET){*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;}returnHAL_ERROR;}*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;}if(I2C_WaitOnSTOPFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_BUSY,SET,Timeout,tickstart)!=HAL_OK){hi2c->Instance->CR2|=I2C_CR2_NACK;returnHAL_ERROR;}hi2c->Instance->CR2|=I2C_CR2_NACK;hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Transmit_IT(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize){uint32_txfermode;if(hi2c->State==HAL_I2C_STATE_READY){if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Master_ISR_IT;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=I2C_AUTOEND_MODE;}if(hi2c->XferSize>0U){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)(hi2c->XferSize+1U),xfermode,I2C_GENERATE_START_WRITE);}else{I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,I2C_GENERATE_START_WRITE);}__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Receive_IT(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize){uint32_txfermode;if(hi2c->State==HAL_I2C_STATE_READY){if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Master_ISR_IT;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=1U;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=I2C_AUTOEND_MODE;}I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,I2C_GENERATE_START_READ);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Slave_Transmit_IT(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize){if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->Instance->CR2&=~I2C_CR2_NACK;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Slave_ISR_IT;if(hi2c->Init.NoStretchMode==I2C_NOSTRETCH_ENABLE){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;}__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT|I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Slave_Receive_IT(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize){if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->Instance->CR2&=~I2C_CR2_NACK;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Slave_ISR_IT;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT|I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Transmit_DMA(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize){uint32_txfermode;HAL_StatusTypeDefdmaxferstatus;uint32_tsizetoxfer=0U;if(hi2c->State==HAL_I2C_STATE_READY){if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Master_ISR_DMA;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=I2C_AUTOEND_MODE;}if(hi2c->XferSize>0U){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;sizetoxfer=hi2c->XferSize;hi2c->XferCount--;hi2c->XferSize--;}if(hi2c->XferSize>0U){if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferCpltCallback=I2C_DMAMasterTransmitCplt;hi2c->hdmatx->XferErrorCallback=I2C_DMAError;hi2c->hdmatx->XferHalfCpltCallback=NULL;hi2c->hdmatx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmatx,(uint32_t)hi2c->pBuffPtr,(uint32_t)&hi2c->Instance->TXDR,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)(hi2c->XferSize+1U),xfermode,I2C_GENERATE_START_WRITE);hi2c->XferCount-=hi2c->XferSize;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_ERROR_IT);hi2c->Instance->CR1|=I2C_CR1_TXDMAEN;}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}else{hi2c->XferISR=I2C_Master_ISR_IT;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)sizetoxfer,I2C_AUTOEND_MODE,I2C_GENERATE_START_WRITE);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Receive_DMA(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize){uint32_txfermode;HAL_StatusTypeDefdmaxferstatus;if(hi2c->State==HAL_I2C_STATE_READY){if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Master_ISR_DMA;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=1U;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=I2C_AUTOEND_MODE;}if(hi2c->XferSize>0U){if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferCpltCallback=I2C_DMAMasterReceiveCplt;hi2c->hdmarx->XferErrorCallback=I2C_DMAError;hi2c->hdmarx->XferHalfCpltCallback=NULL;hi2c->hdmarx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmarx,(uint32_t)&hi2c->Instance->RXDR,(uint32_t)pData,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,I2C_GENERATE_START_READ);hi2c->XferCount-=hi2c->XferSize;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_ERROR_IT);hi2c->Instance->CR1|=I2C_CR1_RXDMAEN;}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}else{hi2c->XferISR=I2C_Master_ISR_IT;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_GENERATE_START_READ);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT);}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Slave_Transmit_DMA(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize){HAL_StatusTypeDefdmaxferstatus;if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Slave_ISR_DMA;if(hi2c->Init.NoStretchMode==I2C_NOSTRETCH_ENABLE){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;}if(hi2c->XferCount!=0U){if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferCpltCallback=I2C_DMASlaveTransmitCplt;hi2c->hdmatx->XferErrorCallback=I2C_DMAError;hi2c->hdmatx->XferHalfCpltCallback=NULL;hi2c->hdmatx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmatx,(uint32_t)hi2c->pBuffPtr,(uint32_t)&hi2c->Instance->TXDR,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){hi2c->Instance->CR2&=~I2C_CR2_NACK;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_LISTEN_IT);hi2c->Instance->CR1|=I2C_CR1_TXDMAEN;}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}else{hi2c->Instance->CR2&=~I2C_CR2_NACK;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_LISTEN_IT);}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Slave_Receive_DMA(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize){HAL_StatusTypeDefdmaxferstatus;if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Slave_ISR_DMA;if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferCpltCallback=I2C_DMASlaveReceiveCplt;hi2c->hdmarx->XferErrorCallback=I2C_DMAError;hi2c->hdmarx->XferHalfCpltCallback=NULL;hi2c->hdmarx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmarx,(uint32_t)&hi2c->Instance->RXDR,(uint32_t)pData,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){hi2c->Instance->CR2&=~I2C_CR2_NACK;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_LISTEN_IT);hi2c->Instance->CR1|=I2C_CR1_RXDMAEN;}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Mem_Write(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint8_t*pData,uint16_tSize,uint32_tTimeout){uint32_ttickstart;assert_param(IS_I2C_MEMADD_SIZE(MemAddSize));if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}__HAL_LOCK(hi2c);tickstart=HAL_GetTick();if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_BUSY,SET,I2C_TIMEOUT_BUSY,tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MEM;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferISR=NULL;if(I2C_RequestMemoryWrite(hi2c,DevAddress,MemAddress,MemAddSize,Timeout,tickstart)!=HAL_OK){__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}do{if(I2C_WaitOnTXISFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;if((hi2c->XferCount!=0U)&&(hi2c->XferSize==0U)){if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_TCR,RESET,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}}}while(hi2c->XferCount>0U);if(I2C_WaitOnSTOPFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);I2C_RESET_CR2(hi2c);hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Mem_Read(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint8_t*pData,uint16_tSize,uint32_tTimeout){uint32_ttickstart;assert_param(IS_I2C_MEMADD_SIZE(MemAddSize));if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}__HAL_LOCK(hi2c);tickstart=HAL_GetTick();if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_BUSY,SET,I2C_TIMEOUT_BUSY,tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MEM;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferISR=NULL;if(I2C_RequestMemoryRead(hi2c,DevAddress,MemAddress,MemAddSize,Timeout,tickstart)!=HAL_OK){__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=1U;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_GENERATE_START_READ);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_GENERATE_START_READ);}do{if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_RXNE,RESET,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;hi2c->XferSize--;hi2c->XferCount--;if((hi2c->XferCount!=0U)&&(hi2c->XferSize==0U)){if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_TCR,RESET,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=1U;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}}}while(hi2c->XferCount>0U);if(I2C_WaitOnSTOPFlagUntilTimeout(hi2c,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);I2C_RESET_CR2(hi2c);hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Mem_Write_IT(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint8_t*pData,uint16_tSize){assert_param(IS_I2C_MEMADD_SIZE(MemAddSize));if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MEM;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->XferSize=0U;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Mem_ISR_IT;hi2c->Devaddress=DevAddress;if(MemAddSize==I2C_MEMADD_SIZE_8BIT){hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);hi2c->Memaddress=0xFFFFFFFFU;}else{hi2c->Instance->TXDR=I2C_MEM_ADD_MSB(MemAddress);hi2c->Memaddress=I2C_MEM_ADD_LSB(MemAddress);}I2C_TransferConfig(hi2c,DevAddress,(uint8_t)MemAddSize,I2C_RELOAD_MODE,I2C_GENERATE_START_WRITE);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Mem_Read_IT(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint8_t*pData,uint16_tSize){assert_param(IS_I2C_MEMADD_SIZE(MemAddSize));if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MEM;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Mem_ISR_IT;hi2c->Devaddress=DevAddress;if(MemAddSize==I2C_MEMADD_SIZE_8BIT){hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);hi2c->Memaddress=0xFFFFFFFFU;}else{hi2c->Instance->TXDR=I2C_MEM_ADD_MSB(MemAddress);hi2c->Memaddress=I2C_MEM_ADD_LSB(MemAddress);}I2C_TransferConfig(hi2c,DevAddress,(uint8_t)MemAddSize,I2C_SOFTEND_MODE,I2C_GENERATE_START_WRITE);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Mem_Write_DMA(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint8_t*pData,uint16_tSize){HAL_StatusTypeDefdmaxferstatus;assert_param(IS_I2C_MEMADD_SIZE(MemAddSize));if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MEM;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Mem_ISR_DMA;hi2c->Devaddress=DevAddress;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;}else{hi2c->XferSize=hi2c->XferCount;}if(MemAddSize==I2C_MEMADD_SIZE_8BIT){hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);hi2c->Memaddress=0xFFFFFFFFU;}else{hi2c->Instance->TXDR=I2C_MEM_ADD_MSB(MemAddress);hi2c->Memaddress=I2C_MEM_ADD_LSB(MemAddress);}if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferCpltCallback=I2C_DMAMasterTransmitCplt;hi2c->hdmatx->XferErrorCallback=I2C_DMAError;hi2c->hdmatx->XferHalfCpltCallback=NULL;hi2c->hdmatx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmatx,(uint32_t)pData,(uint32_t)&hi2c->Instance->TXDR,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)MemAddSize,I2C_RELOAD_MODE,I2C_GENERATE_START_WRITE);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Mem_Read_DMA(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint8_t*pData,uint16_tSize){HAL_StatusTypeDefdmaxferstatus;assert_param(IS_I2C_MEMADD_SIZE(MemAddSize));if(hi2c->State==HAL_I2C_STATE_READY){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MEM;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferISR=I2C_Mem_ISR_DMA;hi2c->Devaddress=DevAddress;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;}else{hi2c->XferSize=hi2c->XferCount;}if(MemAddSize==I2C_MEMADD_SIZE_8BIT){hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);hi2c->Memaddress=0xFFFFFFFFU;}else{hi2c->Instance->TXDR=I2C_MEM_ADD_MSB(MemAddress);hi2c->Memaddress=I2C_MEM_ADD_LSB(MemAddress);}if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferCpltCallback=I2C_DMAMasterReceiveCplt;hi2c->hdmarx->XferErrorCallback=I2C_DMAError;hi2c->hdmarx->XferHalfCpltCallback=NULL;hi2c->hdmarx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmarx,(uint32_t)&hi2c->Instance->RXDR,(uint32_t)pData,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)MemAddSize,I2C_SOFTEND_MODE,I2C_GENERATE_START_WRITE);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_IsDeviceReady(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint32_tTrials,uint32_tTimeout){uint32_ttickstart;__IOuint32_tI2C_Trials=0UL;FlagStatustmp1;FlagStatustmp2;if(hi2c->State==HAL_I2C_STATE_READY){if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)==SET){returnHAL_BUSY;}__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;do{hi2c->Instance->CR2=I2C_GENERATE_START(hi2c->Init.AddressingMode,DevAddress);tickstart=HAL_GetTick();tmp1=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF);tmp2=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_AF);while((tmp1==RESET)&&(tmp2==RESET)){if(Timeout!=HAL_MAX_DELAY){if(((HAL_GetTick()-tickstart)>Timeout)||(Timeout==0U)){hi2c->State=HAL_I2C_STATE_READY;hi2c->ErrorCode|=HAL_I2C_ERROR_TIMEOUT;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}tmp1=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF);tmp2=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_AF);}if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_AF)==RESET){if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_STOPF,RESET,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);hi2c->State=HAL_I2C_STATE_READY;__HAL_UNLOCK(hi2c);returnHAL_OK;}else{if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_STOPF,RESET,Timeout,tickstart)!=HAL_OK){returnHAL_ERROR;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);}I2C_Trials++;}while(I2C_Trials<Trials);hi2c->State=HAL_I2C_STATE_READY;hi2c->ErrorCode|=HAL_I2C_ERROR_TIMEOUT;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Seq_Transmit_IT(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize,uint32_tXferOptions){uint32_txfermode;uint32_txferrequest=I2C_GENERATE_START_WRITE;uint32_tsizetoxfer=0U;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Master_ISR_IT;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=hi2c->XferOptions;}if((hi2c->XferSize>0U)&&((XferOptions==I2C_FIRST_FRAME)||\(XferOptions==I2C_FIRST_AND_LAST_FRAME))){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;sizetoxfer=hi2c->XferSize;hi2c->XferCount--;hi2c->XferSize--;}if((hi2c->PreviousState==I2C_STATE_MASTER_BUSY_TX)&&\(IS_I2C_TRANSFER_OTHER_OPTIONS_REQUEST(XferOptions)==0)){xferrequest=I2C_NO_STARTSTOP;}else{I2C_ConvertOtherXferOptions(hi2c);if(hi2c->XferCount<=MAX_NBYTE_SIZE){xfermode=hi2c->XferOptions;}}if((XferOptions==I2C_FIRST_FRAME)||(XferOptions==I2C_FIRST_AND_LAST_FRAME)){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)sizetoxfer,xfermode,xferrequest);}else{I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,xferrequest);}__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Seq_Transmit_DMA(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize,uint32_tXferOptions){uint32_txfermode;uint32_txferrequest=I2C_GENERATE_START_WRITE;HAL_StatusTypeDefdmaxferstatus;uint32_tsizetoxfer=0U;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_TX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Master_ISR_DMA;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=hi2c->XferOptions;}if((hi2c->XferSize>0U)&&((XferOptions==I2C_FIRST_FRAME)||\(XferOptions==I2C_FIRST_AND_LAST_FRAME))){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;sizetoxfer=hi2c->XferSize;hi2c->XferCount--;hi2c->XferSize--;}if((hi2c->PreviousState==I2C_STATE_MASTER_BUSY_TX)&&\(IS_I2C_TRANSFER_OTHER_OPTIONS_REQUEST(XferOptions)==0)){xferrequest=I2C_NO_STARTSTOP;}else{I2C_ConvertOtherXferOptions(hi2c);if(hi2c->XferCount<=MAX_NBYTE_SIZE){xfermode=hi2c->XferOptions;}}if(hi2c->XferSize>0U){if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferCpltCallback=I2C_DMAMasterTransmitCplt;hi2c->hdmatx->XferErrorCallback=I2C_DMAError;hi2c->hdmatx->XferHalfCpltCallback=NULL;hi2c->hdmatx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmatx,(uint32_t)hi2c->pBuffPtr,(uint32_t)&hi2c->Instance->TXDR,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){if((XferOptions==I2C_FIRST_FRAME)||(XferOptions==I2C_FIRST_AND_LAST_FRAME)){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)sizetoxfer,xfermode,xferrequest);}else{I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,xferrequest);}hi2c->XferCount-=hi2c->XferSize;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_ERROR_IT);hi2c->Instance->CR1|=I2C_CR1_TXDMAEN;}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}else{hi2c->XferISR=I2C_Master_ISR_IT;if((XferOptions==I2C_FIRST_FRAME)||(XferOptions==I2C_FIRST_AND_LAST_FRAME)){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)sizetoxfer,xfermode,xferrequest);}else{I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,xferrequest);}__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT);}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Seq_Receive_IT(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize,uint32_tXferOptions){uint32_txfermode;uint32_txferrequest=I2C_GENERATE_START_READ;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Master_ISR_IT;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=hi2c->XferOptions;}if((hi2c->PreviousState==I2C_STATE_MASTER_BUSY_RX)&&\(IS_I2C_TRANSFER_OTHER_OPTIONS_REQUEST(XferOptions)==0)){xferrequest=I2C_NO_STARTSTOP;}else{I2C_ConvertOtherXferOptions(hi2c);if(hi2c->XferCount<=MAX_NBYTE_SIZE){xfermode=hi2c->XferOptions;}}I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,xferrequest);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Seq_Receive_DMA(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_t*pData,uint16_tSize,uint32_tXferOptions){uint32_txfermode;uint32_txferrequest=I2C_GENERATE_START_READ;HAL_StatusTypeDefdmaxferstatus;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(hi2c->State==HAL_I2C_STATE_READY){__HAL_LOCK(hi2c);hi2c->State=HAL_I2C_STATE_BUSY_RX;hi2c->Mode=HAL_I2C_MODE_MASTER;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Master_ISR_DMA;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;xfermode=hi2c->XferOptions;}if((hi2c->PreviousState==I2C_STATE_MASTER_BUSY_RX)&&\(IS_I2C_TRANSFER_OTHER_OPTIONS_REQUEST(XferOptions)==0)){xferrequest=I2C_NO_STARTSTOP;}else{I2C_ConvertOtherXferOptions(hi2c);if(hi2c->XferCount<=MAX_NBYTE_SIZE){xfermode=hi2c->XferOptions;}}if(hi2c->XferSize>0U){if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferCpltCallback=I2C_DMAMasterReceiveCplt;hi2c->hdmarx->XferErrorCallback=I2C_DMAError;hi2c->hdmarx->XferHalfCpltCallback=NULL;hi2c->hdmarx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmarx,(uint32_t)&hi2c->Instance->RXDR,(uint32_t)pData,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,xfermode,xferrequest);hi2c->XferCount-=hi2c->XferSize;__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_ERROR_IT);hi2c->Instance->CR1|=I2C_CR1_RXDMAEN;}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}else{hi2c->XferISR=I2C_Master_ISR_IT;I2C_TransferConfig(hi2c,DevAddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_GENERATE_START_READ);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT);}returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Slave_Seq_Transmit_IT(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize,uint32_tXferOptions){FlagStatustmp;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(((uint32_t)hi2c->State&(uint32_t)HAL_I2C_STATE_LISTEN)==(uint32_t)HAL_I2C_STATE_LISTEN){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_TX_IT);__HAL_LOCK(hi2c);if(hi2c->State==HAL_I2C_STATE_BUSY_RX_LISTEN){I2C_Disable_IRQ(hi2c,I2C_XFER_RX_IT);if((hi2c->Instance->CR1&I2C_CR1_RXDMAEN)==I2C_CR1_RXDMAEN){hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferAbortCallback=I2C_DMAAbort;if(HAL_DMA_Abort_IT(hi2c->hdmarx)!=HAL_OK){hi2c->hdmarx->XferAbortCallback(hi2c->hdmarx);}}}}hi2c->State=HAL_I2C_STATE_BUSY_TX_LISTEN;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->Instance->CR2&=~I2C_CR2_NACK;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Slave_ISR_IT;tmp=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_ADDR);if((I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE)&&(tmp!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);}__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_TX_IT|I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_ERROR;}}HAL_StatusTypeDefHAL_I2C_Slave_Seq_Transmit_DMA(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize,uint32_tXferOptions){FlagStatustmp;HAL_StatusTypeDefdmaxferstatus;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(((uint32_t)hi2c->State&(uint32_t)HAL_I2C_STATE_LISTEN)==(uint32_t)HAL_I2C_STATE_LISTEN){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}__HAL_LOCK(hi2c);I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_TX_IT);if(hi2c->State==HAL_I2C_STATE_BUSY_RX_LISTEN){I2C_Disable_IRQ(hi2c,I2C_XFER_RX_IT);if((hi2c->Instance->CR1&I2C_CR1_RXDMAEN)==I2C_CR1_RXDMAEN){if(hi2c->hdmarx!=NULL){hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;hi2c->hdmarx->XferAbortCallback=I2C_DMAAbort;if(HAL_DMA_Abort_IT(hi2c->hdmarx)!=HAL_OK){hi2c->hdmarx->XferAbortCallback(hi2c->hdmarx);}}}}elseif(hi2c->State==HAL_I2C_STATE_BUSY_TX_LISTEN){if((hi2c->Instance->CR1&I2C_CR1_TXDMAEN)==I2C_CR1_TXDMAEN){hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferAbortCallback=I2C_DMAAbort;if(HAL_DMA_Abort_IT(hi2c->hdmatx)!=HAL_OK){hi2c->hdmatx->XferAbortCallback(hi2c->hdmatx);}}}}else{}hi2c->State=HAL_I2C_STATE_BUSY_TX_LISTEN;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->Instance->CR2&=~I2C_CR2_NACK;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Slave_ISR_DMA;if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferCpltCallback=I2C_DMASlaveTransmitCplt;hi2c->hdmatx->XferErrorCallback=I2C_DMAError;hi2c->hdmatx->XferHalfCpltCallback=NULL;hi2c->hdmatx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmatx,(uint32_t)pData,(uint32_t)&hi2c->Instance->TXDR,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){hi2c->XferCount-=hi2c->XferSize;hi2c->XferSize=0;}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}tmp=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_ADDR);if((I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE)&&(tmp!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);}__HAL_UNLOCK(hi2c);hi2c->Instance->CR1|=I2C_CR1_TXDMAEN;I2C_Enable_IRQ(hi2c,I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_ERROR;}}HAL_StatusTypeDefHAL_I2C_Slave_Seq_Receive_IT(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize,uint32_tXferOptions){FlagStatustmp;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(((uint32_t)hi2c->State&(uint32_t)HAL_I2C_STATE_LISTEN)==(uint32_t)HAL_I2C_STATE_LISTEN){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_RX_IT);__HAL_LOCK(hi2c);if(hi2c->State==HAL_I2C_STATE_BUSY_TX_LISTEN){I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);if((hi2c->Instance->CR1&I2C_CR1_TXDMAEN)==I2C_CR1_TXDMAEN){hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferAbortCallback=I2C_DMAAbort;if(HAL_DMA_Abort_IT(hi2c->hdmatx)!=HAL_OK){hi2c->hdmatx->XferAbortCallback(hi2c->hdmatx);}}}}hi2c->State=HAL_I2C_STATE_BUSY_RX_LISTEN;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->Instance->CR2&=~I2C_CR2_NACK;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Slave_ISR_IT;tmp=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_ADDR);if((I2C_GET_DIR(hi2c)==I2C_DIRECTION_TRANSMIT)&&(tmp!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);}__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT|I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_ERROR;}}HAL_StatusTypeDefHAL_I2C_Slave_Seq_Receive_DMA(I2C_HandleTypeDef*hi2c,uint8_t*pData,uint16_tSize,uint32_tXferOptions){FlagStatustmp;HAL_StatusTypeDefdmaxferstatus;assert_param(IS_I2C_TRANSFER_OPTIONS_REQUEST(XferOptions));if(((uint32_t)hi2c->State&(uint32_t)HAL_I2C_STATE_LISTEN)==(uint32_t)HAL_I2C_STATE_LISTEN){if((pData==NULL)||(Size==0U)){hi2c->ErrorCode=HAL_I2C_ERROR_INVALID_PARAM;returnHAL_ERROR;}I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_RX_IT);__HAL_LOCK(hi2c);if(hi2c->State==HAL_I2C_STATE_BUSY_TX_LISTEN){I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);if((hi2c->Instance->CR1&I2C_CR1_TXDMAEN)==I2C_CR1_TXDMAEN){if(hi2c->hdmatx!=NULL){hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;hi2c->hdmatx->XferAbortCallback=I2C_DMAAbort;if(HAL_DMA_Abort_IT(hi2c->hdmatx)!=HAL_OK){hi2c->hdmatx->XferAbortCallback(hi2c->hdmatx);}}}}elseif(hi2c->State==HAL_I2C_STATE_BUSY_RX_LISTEN){if((hi2c->Instance->CR1&I2C_CR1_RXDMAEN)==I2C_CR1_RXDMAEN){hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferAbortCallback=I2C_DMAAbort;if(HAL_DMA_Abort_IT(hi2c->hdmarx)!=HAL_OK){hi2c->hdmarx->XferAbortCallback(hi2c->hdmarx);}}}}else{}hi2c->State=HAL_I2C_STATE_BUSY_RX_LISTEN;hi2c->Mode=HAL_I2C_MODE_SLAVE;hi2c->ErrorCode=HAL_I2C_ERROR_NONE;hi2c->Instance->CR2&=~I2C_CR2_NACK;hi2c->pBuffPtr=pData;hi2c->XferCount=Size;hi2c->XferSize=hi2c->XferCount;hi2c->XferOptions=XferOptions;hi2c->XferISR=I2C_Slave_ISR_DMA;if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferCpltCallback=I2C_DMASlaveReceiveCplt;hi2c->hdmarx->XferErrorCallback=I2C_DMAError;hi2c->hdmarx->XferHalfCpltCallback=NULL;hi2c->hdmarx->XferAbortCallback=NULL;dmaxferstatus=HAL_DMA_Start_IT(hi2c->hdmarx,(uint32_t)&hi2c->Instance->RXDR,(uint32_t)pData,hi2c->XferSize);}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA_PARAM;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}if(dmaxferstatus==HAL_OK){hi2c->XferCount-=hi2c->XferSize;hi2c->XferSize=0;}else{hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->ErrorCode|=HAL_I2C_ERROR_DMA;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}tmp=__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_ADDR);if((I2C_GET_DIR(hi2c)==I2C_DIRECTION_TRANSMIT)&&(tmp!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);}__HAL_UNLOCK(hi2c);hi2c->Instance->CR1|=I2C_CR1_RXDMAEN;I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT|I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_ERROR;}}HAL_StatusTypeDefHAL_I2C_EnableListen_IT(I2C_HandleTypeDef*hi2c){if(hi2c->State==HAL_I2C_STATE_READY){hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->XferISR=I2C_Slave_ISR_IT;I2C_Enable_IRQ(hi2c,I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_DisableListen_IT(I2C_HandleTypeDef*hi2c){uint32_ttmp;if(hi2c->State==HAL_I2C_STATE_LISTEN){tmp=(uint32_t)(hi2c->State)&I2C_STATE_MSK;hi2c->PreviousState=tmp|(uint32_t)(hi2c->Mode);hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->XferISR=NULL;I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT);returnHAL_OK;}else{returnHAL_BUSY;}}HAL_StatusTypeDefHAL_I2C_Master_Abort_IT(I2C_HandleTypeDef*hi2c,uint16_tDevAddress){HAL_I2C_ModeTypeDeftmp_mode=hi2c->Mode;if((tmp_mode==HAL_I2C_MODE_MASTER)||(tmp_mode==HAL_I2C_MODE_MEM)){__HAL_LOCK(hi2c);if(hi2c->State==HAL_I2C_STATE_BUSY_TX){I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);hi2c->PreviousState=I2C_STATE_MASTER_BUSY_TX;}elseif(hi2c->State==HAL_I2C_STATE_BUSY_RX){I2C_Disable_IRQ(hi2c,I2C_XFER_RX_IT);hi2c->PreviousState=I2C_STATE_MASTER_BUSY_RX;}else{}hi2c->State=HAL_I2C_STATE_ABORT;I2C_TransferConfig(hi2c,DevAddress,1,I2C_AUTOEND_MODE,I2C_GENERATE_STOP);__HAL_UNLOCK(hi2c);I2C_Enable_IRQ(hi2c,I2C_XFER_CPLT_IT);returnHAL_OK;}else{returnHAL_ERROR;}}voidHAL_I2C_EV_IRQHandler(I2C_HandleTypeDef*hi2c){uint32_titflags=READ_REG(hi2c->Instance->ISR);uint32_titsources=READ_REG(hi2c->Instance->CR1);if(hi2c->XferISR!=NULL){hi2c->XferISR(hi2c,itflags,itsources);}}voidHAL_I2C_ER_IRQHandler(I2C_HandleTypeDef*hi2c){uint32_titflags=READ_REG(hi2c->Instance->ISR);uint32_titsources=READ_REG(hi2c->Instance->CR1);uint32_ttmperror;if((I2C_CHECK_FLAG(itflags,I2C_FLAG_BERR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(itsources,I2C_IT_ERRI)!=RESET)){hi2c->ErrorCode|=HAL_I2C_ERROR_BERR;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_BERR);}if((I2C_CHECK_FLAG(itflags,I2C_FLAG_OVR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(itsources,I2C_IT_ERRI)!=RESET)){hi2c->ErrorCode|=HAL_I2C_ERROR_OVR;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_OVR);}if((I2C_CHECK_FLAG(itflags,I2C_FLAG_ARLO)!=RESET)&&\(I2C_CHECK_IT_SOURCE(itsources,I2C_IT_ERRI)!=RESET)){hi2c->ErrorCode|=HAL_I2C_ERROR_ARLO;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ARLO);}tmperror=hi2c->ErrorCode;if((tmperror&(HAL_I2C_ERROR_BERR|HAL_I2C_ERROR_OVR|HAL_I2C_ERROR_ARLO))!=HAL_I2C_ERROR_NONE){I2C_ITError(hi2c,tmperror);}}__weakvoidHAL_I2C_MasterTxCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_MasterRxCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_SlaveTxCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_SlaveRxCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_AddrCallback(I2C_HandleTypeDef*hi2c,uint8_tTransferDirection,uint16_tAddrMatchCode){UNUSED(hi2c);UNUSED(TransferDirection);UNUSED(AddrMatchCode);}__weakvoidHAL_I2C_ListenCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_MemTxCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_MemRxCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_ErrorCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}__weakvoidHAL_I2C_AbortCpltCallback(I2C_HandleTypeDef*hi2c){UNUSED(hi2c);}HAL_I2C_StateTypeDefHAL_I2C_GetState(constI2C_HandleTypeDef*hi2c){returnhi2c->State;}HAL_I2C_ModeTypeDefHAL_I2C_GetMode(constI2C_HandleTypeDef*hi2c){returnhi2c->Mode;}uint32_tHAL_I2C_GetError(constI2C_HandleTypeDef*hi2c){returnhi2c->ErrorCode;}staticHAL_StatusTypeDefI2C_Master_ISR_IT(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources){uint16_tdevaddress;uint32_ttmpITFlags=ITFlags;__HAL_LOCK(hi2c);if((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_AF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_NACKI)!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;I2C_Flush_TXDR(hi2c);}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_RXNE)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_RXI)!=RESET)){tmpITFlags&=~I2C_FLAG_RXNE;*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;hi2c->XferSize--;hi2c->XferCount--;}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TC)==RESET)&&\((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TXIS)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TXI)!=RESET))){if(hi2c->XferCount!=0U){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferSize--;hi2c->XferCount--;}}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TCR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){if((hi2c->XferCount!=0U)&&(hi2c->XferSize==0U)){devaddress=(uint16_t)(hi2c->Instance->CR2&I2C_CR2_SADD);if(hi2c->XferCount>MAX_NBYTE_SIZE){if(I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE){hi2c->XferSize=1U;}else{hi2c->XferSize=MAX_NBYTE_SIZE;}I2C_TransferConfig(hi2c,devaddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;if(hi2c->XferOptions!=I2C_NO_OPTION_FRAME){I2C_TransferConfig(hi2c,devaddress,(uint8_t)hi2c->XferSize,hi2c->XferOptions,I2C_NO_STARTSTOP);}else{I2C_TransferConfig(hi2c,devaddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}}}else{if(I2C_GET_STOP_MODE(hi2c)!=I2C_AUTOEND_MODE){I2C_ITMasterSeqCplt(hi2c);}else{I2C_ITError(hi2c,HAL_I2C_ERROR_SIZE);}}}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TC)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){if(hi2c->XferCount==0U){if(I2C_GET_STOP_MODE(hi2c)!=I2C_AUTOEND_MODE){if(hi2c->XferOptions==I2C_NO_OPTION_FRAME){hi2c->Instance->CR2|=I2C_CR2_STOP;}else{I2C_ITMasterSeqCplt(hi2c);}}}else{I2C_ITError(hi2c,HAL_I2C_ERROR_SIZE);}}else{}if((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_STOPF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_STOPI)!=RESET)){I2C_ITMasterCplt(hi2c,tmpITFlags);}__HAL_UNLOCK(hi2c);returnHAL_OK;}staticHAL_StatusTypeDefI2C_Mem_ISR_IT(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources){uint32_tdirection=I2C_GENERATE_START_WRITE;uint32_ttmpITFlags=ITFlags;__HAL_LOCK(hi2c);if((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_AF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_NACKI)!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;I2C_Flush_TXDR(hi2c);}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_RXNE)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_RXI)!=RESET)){tmpITFlags&=~I2C_FLAG_RXNE;*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;hi2c->XferSize--;hi2c->XferCount--;}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TXIS)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TXI)!=RESET)){if(hi2c->Memaddress==0xFFFFFFFFU){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferSize--;hi2c->XferCount--;}else{hi2c->Instance->TXDR=hi2c->Memaddress;hi2c->Memaddress=0xFFFFFFFFU;}}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TCR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){if((hi2c->XferCount!=0U)&&(hi2c->XferSize==0U)){if(hi2c->XferCount>MAX_NBYTE_SIZE){if(I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE){hi2c->XferSize=1U;}else{hi2c->XferSize=MAX_NBYTE_SIZE;}I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}}else{I2C_ITError(hi2c,HAL_I2C_ERROR_SIZE);}}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TC)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);I2C_Enable_IRQ(hi2c,I2C_XFER_RX_IT);if(hi2c->State==HAL_I2C_STATE_BUSY_RX){direction=I2C_GENERATE_START_READ;}if(hi2c->XferCount>MAX_NBYTE_SIZE){if(I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE){hi2c->XferSize=1U;}else{hi2c->XferSize=MAX_NBYTE_SIZE;}I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,direction);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,direction);}}else{}if((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_STOPF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_STOPI)!=RESET)){I2C_ITMasterCplt(hi2c,tmpITFlags);}__HAL_UNLOCK(hi2c);returnHAL_OK;}staticHAL_StatusTypeDefI2C_Slave_ISR_IT(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources){uint32_ttmpoptions=hi2c->XferOptions;uint32_ttmpITFlags=ITFlags;__HAL_LOCK(hi2c);if((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_STOPF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_STOPI)!=RESET)){I2C_ITSlaveCplt(hi2c,tmpITFlags);}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_AF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_NACKI)!=RESET)){if(hi2c->XferCount==0U){if((hi2c->State==HAL_I2C_STATE_LISTEN)&&(tmpoptions==I2C_FIRST_AND_LAST_FRAME)){I2C_ITListenCplt(hi2c,tmpITFlags);}elseif((hi2c->State==HAL_I2C_STATE_BUSY_TX_LISTEN)&&(tmpoptions!=I2C_NO_OPTION_FRAME)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);I2C_Flush_TXDR(hi2c);I2C_ITSlaveSeqCplt(hi2c);}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);}}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;if((tmpoptions==I2C_FIRST_FRAME)||(tmpoptions==I2C_NEXT_FRAME)){I2C_ITError(hi2c,hi2c->ErrorCode);}}}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_RXNE)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_RXI)!=RESET)){if(hi2c->XferCount>0U){*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;hi2c->XferSize--;hi2c->XferCount--;}if((hi2c->XferCount==0U)&&\(tmpoptions!=I2C_NO_OPTION_FRAME)){I2C_ITSlaveSeqCplt(hi2c);}}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_ADDR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_ADDRI)!=RESET)){I2C_ITAddrCplt(hi2c,tmpITFlags);}elseif((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_TXIS)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TXI)!=RESET)){if(hi2c->XferCount>0U){hi2c->Instance->TXDR=*hi2c->pBuffPtr;hi2c->pBuffPtr++;hi2c->XferCount--;hi2c->XferSize--;}else{if((tmpoptions==I2C_NEXT_FRAME)||(tmpoptions==I2C_FIRST_FRAME)){I2C_ITSlaveSeqCplt(hi2c);}}}else{}__HAL_UNLOCK(hi2c);returnHAL_OK;}staticHAL_StatusTypeDefI2C_Master_ISR_DMA(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources){uint16_tdevaddress;uint32_txfermode;__HAL_LOCK(hi2c);if((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_AF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_NACKI)!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;I2C_Enable_IRQ(hi2c,I2C_XFER_CPLT_IT);I2C_Flush_TXDR(hi2c);}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_TCR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){__HAL_I2C_DISABLE_IT(hi2c,I2C_IT_TCI);if(hi2c->XferCount!=0U){devaddress=(uint16_t)(hi2c->Instance->CR2&I2C_CR2_SADD);if(hi2c->XferCount>MAX_NBYTE_SIZE){if(I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE){hi2c->XferSize=1U;}else{hi2c->XferSize=MAX_NBYTE_SIZE;}xfermode=I2C_RELOAD_MODE;}else{hi2c->XferSize=hi2c->XferCount;if(hi2c->XferOptions!=I2C_NO_OPTION_FRAME){xfermode=hi2c->XferOptions;}else{xfermode=I2C_AUTOEND_MODE;}}I2C_TransferConfig(hi2c,devaddress,(uint8_t)hi2c->XferSize,xfermode,I2C_NO_STARTSTOP);hi2c->XferCount-=hi2c->XferSize;if(hi2c->State==HAL_I2C_STATE_BUSY_RX){hi2c->Instance->CR1|=I2C_CR1_RXDMAEN;}else{hi2c->Instance->CR1|=I2C_CR1_TXDMAEN;}}else{if(I2C_GET_STOP_MODE(hi2c)!=I2C_AUTOEND_MODE){I2C_ITMasterSeqCplt(hi2c);}else{I2C_ITError(hi2c,HAL_I2C_ERROR_SIZE);}}}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_TC)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){if(hi2c->XferCount==0U){if(I2C_GET_STOP_MODE(hi2c)!=I2C_AUTOEND_MODE){if(hi2c->XferOptions==I2C_NO_OPTION_FRAME){hi2c->Instance->CR2|=I2C_CR2_STOP;}else{I2C_ITMasterSeqCplt(hi2c);}}}else{I2C_ITError(hi2c,HAL_I2C_ERROR_SIZE);}}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_STOPF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_STOPI)!=RESET)){I2C_ITMasterCplt(hi2c,ITFlags);}else{}__HAL_UNLOCK(hi2c);returnHAL_OK;}staticHAL_StatusTypeDefI2C_Mem_ISR_DMA(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources){uint32_tdirection=I2C_GENERATE_START_WRITE;__HAL_LOCK(hi2c);if((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_AF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_NACKI)!=RESET)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;I2C_Enable_IRQ(hi2c,I2C_XFER_CPLT_IT);I2C_Flush_TXDR(hi2c);}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_TXIS)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TXI)!=RESET)){hi2c->Instance->TXDR=hi2c->Memaddress;hi2c->Memaddress=0xFFFFFFFFU;}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_TCR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);I2C_Enable_IRQ(hi2c,I2C_XFER_ERROR_IT);if(hi2c->XferCount!=0U){if(hi2c->XferCount>MAX_NBYTE_SIZE){if(I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE){hi2c->XferSize=1U;}else{hi2c->XferSize=MAX_NBYTE_SIZE;}I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,I2C_NO_STARTSTOP);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,I2C_NO_STARTSTOP);}hi2c->XferCount-=hi2c->XferSize;if(hi2c->State==HAL_I2C_STATE_BUSY_RX){hi2c->Instance->CR1|=I2C_CR1_RXDMAEN;}else{hi2c->Instance->CR1|=I2C_CR1_TXDMAEN;}}else{I2C_ITError(hi2c,HAL_I2C_ERROR_SIZE);}}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_TC)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_TCI)!=RESET)){I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);I2C_Enable_IRQ(hi2c,I2C_XFER_ERROR_IT);if(hi2c->State==HAL_I2C_STATE_BUSY_RX){direction=I2C_GENERATE_START_READ;}if(hi2c->XferCount>MAX_NBYTE_SIZE){if(I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE){hi2c->XferSize=1U;}else{hi2c->XferSize=MAX_NBYTE_SIZE;}I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_RELOAD_MODE,direction);}else{hi2c->XferSize=hi2c->XferCount;I2C_TransferConfig(hi2c,(uint16_t)hi2c->Devaddress,(uint8_t)hi2c->XferSize,I2C_AUTOEND_MODE,direction);}hi2c->XferCount-=hi2c->XferSize;if(hi2c->State==HAL_I2C_STATE_BUSY_RX){hi2c->Instance->CR1|=I2C_CR1_RXDMAEN;}else{hi2c->Instance->CR1|=I2C_CR1_TXDMAEN;}}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_STOPF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_STOPI)!=RESET)){I2C_ITMasterCplt(hi2c,ITFlags);}else{}__HAL_UNLOCK(hi2c);returnHAL_OK;}staticHAL_StatusTypeDefI2C_Slave_ISR_DMA(struct__I2C_HandleTypeDef*hi2c,uint32_tITFlags,uint32_tITSources){uint32_ttmpoptions=hi2c->XferOptions;uint32_ttreatdmanack=0U;HAL_I2C_StateTypeDeftmpstate;__HAL_LOCK(hi2c);if((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_STOPF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_STOPI)!=RESET)){I2C_ITSlaveCplt(hi2c,ITFlags);}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_AF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_NACKI)!=RESET)){if((I2C_CHECK_IT_SOURCE(ITSources,I2C_CR1_TXDMAEN)!=RESET)||(I2C_CHECK_IT_SOURCE(ITSources,I2C_CR1_RXDMAEN)!=RESET)){if(hi2c->hdmarx!=NULL){if(I2C_CHECK_IT_SOURCE(ITSources,I2C_CR1_RXDMAEN)!=RESET){if(I2C_GET_DMA_REMAIN_DATA(hi2c->hdmarx)==0U){treatdmanack=1U;}}}if(hi2c->hdmatx!=NULL){if(I2C_CHECK_IT_SOURCE(ITSources,I2C_CR1_TXDMAEN)!=RESET){if(I2C_GET_DMA_REMAIN_DATA(hi2c->hdmatx)==0U){treatdmanack=1U;}}}if(treatdmanack==1U){if((hi2c->State==HAL_I2C_STATE_LISTEN)&&(tmpoptions==I2C_FIRST_AND_LAST_FRAME)){I2C_ITListenCplt(hi2c,ITFlags);}elseif((hi2c->State==HAL_I2C_STATE_BUSY_TX_LISTEN)&&(tmpoptions!=I2C_NO_OPTION_FRAME)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);I2C_Flush_TXDR(hi2c);I2C_ITSlaveSeqCplt(hi2c);}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);}}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;tmpstate=hi2c->State;if((tmpoptions==I2C_FIRST_FRAME)||(tmpoptions==I2C_NEXT_FRAME)){if((tmpstate==HAL_I2C_STATE_BUSY_TX)||(tmpstate==HAL_I2C_STATE_BUSY_TX_LISTEN)){hi2c->PreviousState=I2C_STATE_SLAVE_BUSY_TX;}elseif((tmpstate==HAL_I2C_STATE_BUSY_RX)||(tmpstate==HAL_I2C_STATE_BUSY_RX_LISTEN)){hi2c->PreviousState=I2C_STATE_SLAVE_BUSY_RX;}else{}I2C_ITError(hi2c,hi2c->ErrorCode);}}}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);}}elseif((I2C_CHECK_FLAG(ITFlags,I2C_FLAG_ADDR)!=RESET)&&\(I2C_CHECK_IT_SOURCE(ITSources,I2C_IT_ADDRI)!=RESET)){I2C_ITAddrCplt(hi2c,ITFlags);}else{}__HAL_UNLOCK(hi2c);returnHAL_OK;}staticHAL_StatusTypeDefI2C_RequestMemoryWrite(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint32_tTimeout,uint32_tTickstart){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)MemAddSize,I2C_RELOAD_MODE,I2C_GENERATE_START_WRITE);if(I2C_WaitOnTXISFlagUntilTimeout(hi2c,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}if(MemAddSize==I2C_MEMADD_SIZE_8BIT){hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);}else{hi2c->Instance->TXDR=I2C_MEM_ADD_MSB(MemAddress);if(I2C_WaitOnTXISFlagUntilTimeout(hi2c,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);}if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_TCR,RESET,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}returnHAL_OK;}staticHAL_StatusTypeDefI2C_RequestMemoryRead(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint16_tMemAddress,uint16_tMemAddSize,uint32_tTimeout,uint32_tTickstart){I2C_TransferConfig(hi2c,DevAddress,(uint8_t)MemAddSize,I2C_SOFTEND_MODE,I2C_GENERATE_START_WRITE);if(I2C_WaitOnTXISFlagUntilTimeout(hi2c,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}if(MemAddSize==I2C_MEMADD_SIZE_8BIT){hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);}else{hi2c->Instance->TXDR=I2C_MEM_ADD_MSB(MemAddress);if(I2C_WaitOnTXISFlagUntilTimeout(hi2c,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}hi2c->Instance->TXDR=I2C_MEM_ADD_LSB(MemAddress);}if(I2C_WaitOnFlagUntilTimeout(hi2c,I2C_FLAG_TC,RESET,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}returnHAL_OK;}staticvoidI2C_ITAddrCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags){uint8_ttransferdirection;uint16_tslaveaddrcode;uint16_townadd1code;uint16_townadd2code;UNUSED(ITFlags);if(((uint32_t)hi2c->State&(uint32_t)HAL_I2C_STATE_LISTEN)==(uint32_t)HAL_I2C_STATE_LISTEN){transferdirection=I2C_GET_DIR(hi2c);slaveaddrcode=I2C_GET_ADDR_MATCH(hi2c);ownadd1code=I2C_GET_OWN_ADDRESS1(hi2c);ownadd2code=I2C_GET_OWN_ADDRESS2(hi2c);if(hi2c->Init.AddressingMode==I2C_ADDRESSINGMODE_10BIT){if((slaveaddrcode&SLAVE_ADDR_MSK)==((ownadd1code>>SLAVE_ADDR_SHIFT)&SLAVE_ADDR_MSK)){slaveaddrcode=ownadd1code;hi2c->AddrEventCount++;if(hi2c->AddrEventCount==2U){hi2c->AddrEventCount=0U;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->AddrCallback(hi2c,transferdirection,slaveaddrcode);#elseHAL_I2C_AddrCallback(hi2c,transferdirection,slaveaddrcode);#endif}}else{slaveaddrcode=ownadd2code;I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->AddrCallback(hi2c,transferdirection,slaveaddrcode);#elseHAL_I2C_AddrCallback(hi2c,transferdirection,slaveaddrcode);#endif}}else{I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->AddrCallback(hi2c,transferdirection,slaveaddrcode);#elseHAL_I2C_AddrCallback(hi2c,transferdirection,slaveaddrcode);#endif}}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ADDR);__HAL_UNLOCK(hi2c);}}staticvoidI2C_ITMasterSeqCplt(I2C_HandleTypeDef*hi2c){hi2c->Mode=HAL_I2C_MODE_NONE;if(hi2c->State==HAL_I2C_STATE_BUSY_TX){hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_MASTER_BUSY_TX;hi2c->XferISR=NULL;I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->MasterTxCpltCallback(hi2c);#elseHAL_I2C_MasterTxCpltCallback(hi2c);#endif}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_MASTER_BUSY_RX;hi2c->XferISR=NULL;I2C_Disable_IRQ(hi2c,I2C_XFER_RX_IT);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->MasterRxCpltCallback(hi2c);#elseHAL_I2C_MasterRxCpltCallback(hi2c);#endif}}staticvoidI2C_ITSlaveSeqCplt(I2C_HandleTypeDef*hi2c){uint32_ttmpcr1value=READ_REG(hi2c->Instance->CR1);hi2c->Mode=HAL_I2C_MODE_NONE;if(I2C_CHECK_IT_SOURCE(tmpcr1value,I2C_CR1_TXDMAEN)!=RESET){hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;}elseif(I2C_CHECK_IT_SOURCE(tmpcr1value,I2C_CR1_RXDMAEN)!=RESET){hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;}else{}if(hi2c->State==HAL_I2C_STATE_BUSY_TX_LISTEN){hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->PreviousState=I2C_STATE_SLAVE_BUSY_TX;I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->SlaveTxCpltCallback(hi2c);#elseHAL_I2C_SlaveTxCpltCallback(hi2c);#endif}elseif(hi2c->State==HAL_I2C_STATE_BUSY_RX_LISTEN){hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->PreviousState=I2C_STATE_SLAVE_BUSY_RX;I2C_Disable_IRQ(hi2c,I2C_XFER_RX_IT);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->SlaveRxCpltCallback(hi2c);#elseHAL_I2C_SlaveRxCpltCallback(hi2c);#endif}else{}}staticvoidI2C_ITMasterCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags){uint32_ttmperror;uint32_ttmpITFlags=ITFlags;__IOuint32_ttmpreg;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);if(hi2c->State==HAL_I2C_STATE_BUSY_TX){I2C_Disable_IRQ(hi2c,I2C_XFER_TX_IT);hi2c->PreviousState=I2C_STATE_MASTER_BUSY_TX;}elseif(hi2c->State==HAL_I2C_STATE_BUSY_RX){I2C_Disable_IRQ(hi2c,I2C_XFER_RX_IT);hi2c->PreviousState=I2C_STATE_MASTER_BUSY_RX;}else{}I2C_RESET_CR2(hi2c);hi2c->XferISR=NULL;hi2c->XferOptions=I2C_NO_OPTION_FRAME;if(I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_AF)!=RESET){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;}if((hi2c->State==HAL_I2C_STATE_ABORT)&&(I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_RXNE)!=RESET)){tmpreg=(uint8_t)hi2c->Instance->RXDR;UNUSED(tmpreg);}I2C_Flush_TXDR(hi2c);tmperror=hi2c->ErrorCode;if((hi2c->State==HAL_I2C_STATE_ABORT)||(tmperror!=HAL_I2C_ERROR_NONE)){I2C_ITError(hi2c,hi2c->ErrorCode);}elseif(hi2c->State==HAL_I2C_STATE_BUSY_TX){hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_NONE;if(hi2c->Mode==HAL_I2C_MODE_MEM){hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->MemTxCpltCallback(hi2c);#elseHAL_I2C_MemTxCpltCallback(hi2c);#endif}else{hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->MasterTxCpltCallback(hi2c);#elseHAL_I2C_MasterTxCpltCallback(hi2c);#endif}}elseif(hi2c->State==HAL_I2C_STATE_BUSY_RX){hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_NONE;if(hi2c->Mode==HAL_I2C_MODE_MEM){hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->MemRxCpltCallback(hi2c);#elseHAL_I2C_MemRxCpltCallback(hi2c);#endif}else{hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->MasterRxCpltCallback(hi2c);#elseHAL_I2C_MasterRxCpltCallback(hi2c);#endif}}else{}}staticvoidI2C_ITSlaveCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags){uint32_ttmpcr1value=READ_REG(hi2c->Instance->CR1);uint32_ttmpITFlags=ITFlags;uint32_ttmpoptions=hi2c->XferOptions;HAL_I2C_StateTypeDeftmpstate=hi2c->State;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);if((tmpstate==HAL_I2C_STATE_BUSY_TX)||(tmpstate==HAL_I2C_STATE_BUSY_TX_LISTEN)){I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_TX_IT);hi2c->PreviousState=I2C_STATE_SLAVE_BUSY_TX;}elseif((tmpstate==HAL_I2C_STATE_BUSY_RX)||(tmpstate==HAL_I2C_STATE_BUSY_RX_LISTEN)){I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_RX_IT);hi2c->PreviousState=I2C_STATE_SLAVE_BUSY_RX;}elseif(tmpstate==HAL_I2C_STATE_LISTEN){I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_TX_IT|I2C_XFER_RX_IT);hi2c->PreviousState=I2C_STATE_NONE;}else{}hi2c->Instance->CR2|=I2C_CR2_NACK;I2C_RESET_CR2(hi2c);I2C_Flush_TXDR(hi2c);if(I2C_CHECK_IT_SOURCE(tmpcr1value,I2C_CR1_TXDMAEN)!=RESET){hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;if(hi2c->hdmatx!=NULL){hi2c->XferCount=(uint16_t)I2C_GET_DMA_REMAIN_DATA(hi2c->hdmatx);}}elseif(I2C_CHECK_IT_SOURCE(tmpcr1value,I2C_CR1_RXDMAEN)!=RESET){hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;if(hi2c->hdmarx!=NULL){hi2c->XferCount=(uint16_t)I2C_GET_DMA_REMAIN_DATA(hi2c->hdmarx);}}else{}if(I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_RXNE)!=RESET){tmpITFlags&=~I2C_FLAG_RXNE;*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;if((hi2c->XferSize>0U)){hi2c->XferSize--;hi2c->XferCount--;}}if(hi2c->XferCount!=0U){hi2c->ErrorCode|=HAL_I2C_ERROR_AF;}if((I2C_CHECK_FLAG(tmpITFlags,I2C_FLAG_AF)!=RESET)&&\(I2C_CHECK_IT_SOURCE(tmpcr1value,I2C_IT_NACKI)!=RESET)){if(hi2c->XferCount==0U){if((hi2c->State==HAL_I2C_STATE_LISTEN)&&(tmpoptions==I2C_FIRST_AND_LAST_FRAME)){I2C_ITListenCplt(hi2c,tmpITFlags);}elseif((hi2c->State==HAL_I2C_STATE_BUSY_TX_LISTEN)&&(tmpoptions!=I2C_NO_OPTION_FRAME)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);I2C_Flush_TXDR(hi2c);I2C_ITSlaveSeqCplt(hi2c);}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);}}else{__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;if((tmpoptions==I2C_FIRST_FRAME)||(tmpoptions==I2C_NEXT_FRAME)){I2C_ITError(hi2c,hi2c->ErrorCode);}}}hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->XferISR=NULL;if(hi2c->ErrorCode!=HAL_I2C_ERROR_NONE){I2C_ITError(hi2c,hi2c->ErrorCode);if(hi2c->State==HAL_I2C_STATE_LISTEN){I2C_ITListenCplt(hi2c,tmpITFlags);}}elseif(hi2c->XferOptions!=I2C_NO_OPTION_FRAME){I2C_ITSlaveSeqCplt(hi2c);hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->ListenCpltCallback(hi2c);#elseHAL_I2C_ListenCpltCallback(hi2c);#endif}elseif(hi2c->State==HAL_I2C_STATE_BUSY_RX){hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->SlaveRxCpltCallback(hi2c);#elseHAL_I2C_SlaveRxCpltCallback(hi2c);#endif}else{hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->SlaveTxCpltCallback(hi2c);#elseHAL_I2C_SlaveTxCpltCallback(hi2c);#endif}}staticvoidI2C_ITListenCplt(I2C_HandleTypeDef*hi2c,uint32_tITFlags){hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->PreviousState=I2C_STATE_NONE;hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->XferISR=NULL;if(I2C_CHECK_FLAG(ITFlags,I2C_FLAG_RXNE)!=RESET){*hi2c->pBuffPtr=(uint8_t)hi2c->Instance->RXDR;hi2c->pBuffPtr++;if((hi2c->XferSize>0U)){hi2c->XferSize--;hi2c->XferCount--;hi2c->ErrorCode|=HAL_I2C_ERROR_AF;}}I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_RX_IT|I2C_XFER_TX_IT);__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->ListenCpltCallback(hi2c);#elseHAL_I2C_ListenCpltCallback(hi2c);#endif}staticvoidI2C_ITError(I2C_HandleTypeDef*hi2c,uint32_tErrorCode){HAL_I2C_StateTypeDeftmpstate=hi2c->State;uint32_ttmppreviousstate;hi2c->Mode=HAL_I2C_MODE_NONE;hi2c->XferOptions=I2C_NO_OPTION_FRAME;hi2c->XferCount=0U;hi2c->ErrorCode|=ErrorCode;if((tmpstate==HAL_I2C_STATE_LISTEN)||(tmpstate==HAL_I2C_STATE_BUSY_TX_LISTEN)||(tmpstate==HAL_I2C_STATE_BUSY_RX_LISTEN)){I2C_Disable_IRQ(hi2c,I2C_XFER_RX_IT|I2C_XFER_TX_IT);hi2c->State=HAL_I2C_STATE_LISTEN;hi2c->XferISR=I2C_Slave_ISR_IT;}else{I2C_Disable_IRQ(hi2c,I2C_XFER_LISTEN_IT|I2C_XFER_RX_IT|I2C_XFER_TX_IT);I2C_Flush_TXDR(hi2c);if(hi2c->State!=HAL_I2C_STATE_ABORT){hi2c->State=HAL_I2C_STATE_READY;if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF)==SET){if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_AF)==SET){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode|=HAL_I2C_ERROR_AF;}__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);}}hi2c->XferISR=NULL;}tmppreviousstate=hi2c->PreviousState;if((hi2c->hdmatx!=NULL)&&((tmppreviousstate==I2C_STATE_MASTER_BUSY_TX)||\(tmppreviousstate==I2C_STATE_SLAVE_BUSY_TX))){if((hi2c->Instance->CR1&I2C_CR1_TXDMAEN)==I2C_CR1_TXDMAEN){hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;}if(HAL_DMA_GetState(hi2c->hdmatx)!=HAL_DMA_STATE_READY){hi2c->hdmatx->XferAbortCallback=I2C_DMAAbort;__HAL_UNLOCK(hi2c);if(HAL_DMA_Abort_IT(hi2c->hdmatx)!=HAL_OK){hi2c->hdmatx->XferAbortCallback(hi2c->hdmatx);}}else{I2C_TreatErrorCallback(hi2c);}}elseif((hi2c->hdmarx!=NULL)&&((tmppreviousstate==I2C_STATE_MASTER_BUSY_RX)||\(tmppreviousstate==I2C_STATE_SLAVE_BUSY_RX))){if((hi2c->Instance->CR1&I2C_CR1_RXDMAEN)==I2C_CR1_RXDMAEN){hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;}if(HAL_DMA_GetState(hi2c->hdmarx)!=HAL_DMA_STATE_READY){hi2c->hdmarx->XferAbortCallback=I2C_DMAAbort;__HAL_UNLOCK(hi2c);if(HAL_DMA_Abort_IT(hi2c->hdmarx)!=HAL_OK){hi2c->hdmarx->XferAbortCallback(hi2c->hdmarx);}}else{I2C_TreatErrorCallback(hi2c);}}else{I2C_TreatErrorCallback(hi2c);}}staticvoidI2C_TreatErrorCallback(I2C_HandleTypeDef*hi2c){if(hi2c->State==HAL_I2C_STATE_ABORT){hi2c->State=HAL_I2C_STATE_READY;hi2c->PreviousState=I2C_STATE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->AbortCpltCallback(hi2c);#elseHAL_I2C_AbortCpltCallback(hi2c);#endif}else{hi2c->PreviousState=I2C_STATE_NONE;__HAL_UNLOCK(hi2c);#if(USE_HAL_I2C_REGISTER_CALLBACKS==1)hi2c->ErrorCallback(hi2c);#elseHAL_I2C_ErrorCallback(hi2c);#endif}}staticvoidI2C_Flush_TXDR(I2C_HandleTypeDef*hi2c){if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_TXIS)!=RESET){hi2c->Instance->TXDR=0x00U;}if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_TXE)==RESET){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_TXE);}}staticvoidI2C_DMAMasterTransmitCplt(DMA_HandleTypeDef*hdma){I2C_HandleTypeDef*hi2c=(I2C_HandleTypeDef*)(((DMA_HandleTypeDef*)hdma)->Parent);hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;if(hi2c->XferCount==0U){I2C_Enable_IRQ(hi2c,I2C_XFER_CPLT_IT);}else{hi2c->pBuffPtr+=hi2c->XferSize;if(hi2c->XferCount>MAX_NBYTE_SIZE){hi2c->XferSize=MAX_NBYTE_SIZE;}else{hi2c->XferSize=hi2c->XferCount;}if(HAL_DMA_Start_IT(hi2c->hdmatx,(uint32_t)hi2c->pBuffPtr,(uint32_t)&hi2c->Instance->TXDR,hi2c->XferSize)!=HAL_OK){I2C_ITError(hi2c,HAL_I2C_ERROR_DMA);}else{I2C_Enable_IRQ(hi2c,I2C_XFER_RELOAD_IT);}}}staticvoidI2C_DMASlaveTransmitCplt(DMA_HandleTypeDef*hdma){I2C_HandleTypeDef*hi2c=(I2C_HandleTypeDef*)(((DMA_HandleTypeDef*)hdma)->Parent);uint32_ttmpoptions=hi2c->XferOptions;if((tmpoptions==I2C_NEXT_FRAME)||(tmpoptions==I2C_FIRST_FRAME)){hi2c->Instance->CR1&=~I2C_CR1_TXDMAEN;I2C_ITSlaveSeqCplt(hi2c);}else{}}staticvoidI2C_DMAMasterReceiveCplt(DMA_HandleTypeDef*hdma){I2C_HandleTypeDef*hi2c=(I2C_HandleTypeDef*)(((DMA_HandleTypeDef*)hdma)->Parent);hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;if(hi2c->XferCount==0U){I2C_Enable_IRQ(hi2c,I2C_XFER_CPLT_IT);}else{hi2c->pBuffPtr+=hi2c->XferSize;if(hi2c->XferCount>MAX_NBYTE_SIZE){if(I2C_GET_DIR(hi2c)==I2C_DIRECTION_RECEIVE){hi2c->XferSize=1U;}else{hi2c->XferSize=MAX_NBYTE_SIZE;}}else{hi2c->XferSize=hi2c->XferCount;}if(HAL_DMA_Start_IT(hi2c->hdmarx,(uint32_t)&hi2c->Instance->RXDR,(uint32_t)hi2c->pBuffPtr,hi2c->XferSize)!=HAL_OK){I2C_ITError(hi2c,HAL_I2C_ERROR_DMA);}else{I2C_Enable_IRQ(hi2c,I2C_XFER_RELOAD_IT);}}}staticvoidI2C_DMASlaveReceiveCplt(DMA_HandleTypeDef*hdma){I2C_HandleTypeDef*hi2c=(I2C_HandleTypeDef*)(((DMA_HandleTypeDef*)hdma)->Parent);uint32_ttmpoptions=hi2c->XferOptions;if((I2C_GET_DMA_REMAIN_DATA(hi2c->hdmarx)==0U)&&\(tmpoptions!=I2C_NO_OPTION_FRAME)){hi2c->Instance->CR1&=~I2C_CR1_RXDMAEN;I2C_ITSlaveSeqCplt(hi2c);}else{}}staticvoidI2C_DMAError(DMA_HandleTypeDef*hdma){I2C_HandleTypeDef*hi2c=(I2C_HandleTypeDef*)(((DMA_HandleTypeDef*)hdma)->Parent);hi2c->Instance->CR2|=I2C_CR2_NACK;I2C_ITError(hi2c,HAL_I2C_ERROR_DMA);}staticvoidI2C_DMAAbort(DMA_HandleTypeDef*hdma){I2C_HandleTypeDef*hi2c=(I2C_HandleTypeDef*)(((DMA_HandleTypeDef*)hdma)->Parent);if(hi2c->hdmatx!=NULL){hi2c->hdmatx->XferAbortCallback=NULL;}if(hi2c->hdmarx!=NULL){hi2c->hdmarx->XferAbortCallback=NULL;}I2C_TreatErrorCallback(hi2c);}staticHAL_StatusTypeDefI2C_WaitOnFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tFlag,FlagStatusStatus,uint32_tTimeout,uint32_tTickstart){while(__HAL_I2C_GET_FLAG(hi2c,Flag)==Status){if(I2C_IsErrorOccurred(hi2c,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}if(Timeout!=HAL_MAX_DELAY){if(((HAL_GetTick()-Tickstart)>Timeout)||(Timeout==0U)){if((__HAL_I2C_GET_FLAG(hi2c,Flag)==Status)){hi2c->ErrorCode|=HAL_I2C_ERROR_TIMEOUT;hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}}}returnHAL_OK;}staticHAL_StatusTypeDefI2C_WaitOnTXISFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart){while(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_TXIS)==RESET){if(I2C_IsErrorOccurred(hi2c,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}if(Timeout!=HAL_MAX_DELAY){if(((HAL_GetTick()-Tickstart)>Timeout)||(Timeout==0U)){if((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_TXIS)==RESET)){hi2c->ErrorCode|=HAL_I2C_ERROR_TIMEOUT;hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}}}returnHAL_OK;}staticHAL_StatusTypeDefI2C_WaitOnSTOPFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart){while(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF)==RESET){if(I2C_IsErrorOccurred(hi2c,Timeout,Tickstart)!=HAL_OK){returnHAL_ERROR;}if(((HAL_GetTick()-Tickstart)>Timeout)||(Timeout==0U)){if((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF)==RESET)){hi2c->ErrorCode|=HAL_I2C_ERROR_TIMEOUT;hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);returnHAL_ERROR;}}}returnHAL_OK;}staticHAL_StatusTypeDefI2C_WaitOnRXNEFlagUntilTimeout(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart){HAL_StatusTypeDefstatus=HAL_OK;while((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_RXNE)==RESET)&&(status==HAL_OK)){if(I2C_IsErrorOccurred(hi2c,Timeout,Tickstart)!=HAL_OK){status=HAL_ERROR;}if((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF)==SET)&&(status==HAL_OK)){if((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_RXNE)==SET)&&(hi2c->XferSize>0U)){status=HAL_OK;}if(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_AF)==SET){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);hi2c->ErrorCode=HAL_I2C_ERROR_AF;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);I2C_RESET_CR2(hi2c);hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);status=HAL_ERROR;}else{hi2c->ErrorCode=HAL_I2C_ERROR_NONE;}}if((((HAL_GetTick()-Tickstart)>Timeout)||(Timeout==0U))&&(status==HAL_OK)){if((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_RXNE)==RESET)){hi2c->ErrorCode|=HAL_I2C_ERROR_TIMEOUT;hi2c->State=HAL_I2C_STATE_READY;__HAL_UNLOCK(hi2c);status=HAL_ERROR;}}}returnstatus;}staticHAL_StatusTypeDefI2C_IsErrorOccurred(I2C_HandleTypeDef*hi2c,uint32_tTimeout,uint32_tTickstart){HAL_StatusTypeDefstatus=HAL_OK;uint32_titflag=hi2c->Instance->ISR;uint32_terror_code=0;uint32_ttickstart=Tickstart;uint32_ttmp1;HAL_I2C_ModeTypeDeftmp2;if(HAL_IS_BIT_SET(itflag,I2C_FLAG_AF)){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_AF);while((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF)==RESET)&&(status==HAL_OK)){if(Timeout!=HAL_MAX_DELAY){if(((HAL_GetTick()-tickstart)>Timeout)||(Timeout==0U)){tmp1=(uint32_t)(hi2c->Instance->CR2&I2C_CR2_STOP);tmp2=hi2c->Mode;if((__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_BUSY)!=RESET)&&\(tmp1!=I2C_CR2_STOP)&&\(tmp2!=HAL_I2C_MODE_SLAVE)){hi2c->Instance->CR2|=I2C_CR2_STOP;tickstart=HAL_GetTick();}while(__HAL_I2C_GET_FLAG(hi2c,I2C_FLAG_STOPF)==RESET){if((HAL_GetTick()-tickstart)>I2C_TIMEOUT_STOPF){error_code|=HAL_I2C_ERROR_TIMEOUT;status=HAL_ERROR;break;}}}}}if(status==HAL_OK){__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_STOPF);}error_code|=HAL_I2C_ERROR_AF;status=HAL_ERROR;}itflag=hi2c->Instance->ISR;if(HAL_IS_BIT_SET(itflag,I2C_FLAG_BERR)){error_code|=HAL_I2C_ERROR_BERR;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_BERR);status=HAL_ERROR;}if(HAL_IS_BIT_SET(itflag,I2C_FLAG_OVR)){error_code|=HAL_I2C_ERROR_OVR;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_OVR);status=HAL_ERROR;}if(HAL_IS_BIT_SET(itflag,I2C_FLAG_ARLO)){error_code|=HAL_I2C_ERROR_ARLO;__HAL_I2C_CLEAR_FLAG(hi2c,I2C_FLAG_ARLO);status=HAL_ERROR;}if(status!=HAL_OK){I2C_Flush_TXDR(hi2c);I2C_RESET_CR2(hi2c);hi2c->ErrorCode|=error_code;hi2c->State=HAL_I2C_STATE_READY;hi2c->Mode=HAL_I2C_MODE_NONE;__HAL_UNLOCK(hi2c);}returnstatus;}staticvoidI2C_TransferConfig(I2C_HandleTypeDef*hi2c,uint16_tDevAddress,uint8_tSize,uint32_tMode,uint32_tRequest){assert_param(IS_I2C_ALL_INSTANCE(hi2c->Instance));assert_param(IS_TRANSFER_MODE(Mode));assert_param(IS_TRANSFER_REQUEST(Request));uint32_ttmp=((uint32_t)(((uint32_t)DevAddress&I2C_CR2_SADD)|\(((uint32_t)Size<<I2C_CR2_NBYTES_Pos)&I2C_CR2_NBYTES)|\(uint32_t)Mode|(uint32_t)Request)&(~0x80000000U));MODIFY_REG(hi2c->Instance->CR2,\((I2C_CR2_SADD|I2C_CR2_NBYTES|I2C_CR2_RELOAD|I2C_CR2_AUTOEND|\(I2C_CR2_RD_WRN&(uint32_t)(Request>>(31U-I2C_CR2_RD_WRN_Pos)))|\I2C_CR2_START|I2C_CR2_STOP)),tmp);}staticvoidI2C_Enable_IRQ(I2C_HandleTypeDef*hi2c,uint16_tInterruptRequest){uint32_ttmpisr=0U;if((hi2c->XferISR!=I2C_Master_ISR_DMA)&&\(hi2c->XferISR!=I2C_Slave_ISR_DMA)&&\(hi2c->XferISR!=I2C_Mem_ISR_DMA)){if((InterruptRequest&I2C_XFER_LISTEN_IT)==I2C_XFER_LISTEN_IT){tmpisr|=I2C_IT_ADDRI|I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_ERRI;}if((InterruptRequest&I2C_XFER_TX_IT)==I2C_XFER_TX_IT){tmpisr|=I2C_IT_ERRI|I2C_IT_TCI|I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_TXI;}if((InterruptRequest&I2C_XFER_RX_IT)==I2C_XFER_RX_IT){tmpisr|=I2C_IT_ERRI|I2C_IT_TCI|I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_RXI;}if(InterruptRequest==I2C_XFER_ERROR_IT){tmpisr|=I2C_IT_ERRI|I2C_IT_NACKI;}if(InterruptRequest==I2C_XFER_CPLT_IT){tmpisr|=I2C_IT_STOPI;}}else{if((InterruptRequest&I2C_XFER_LISTEN_IT)==I2C_XFER_LISTEN_IT){tmpisr|=I2C_IT_ADDRI|I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_ERRI;}if((InterruptRequest&I2C_XFER_TX_IT)==I2C_XFER_TX_IT){tmpisr|=I2C_IT_ERRI|I2C_IT_TCI|I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_TXI;}if((InterruptRequest&I2C_XFER_RX_IT)==I2C_XFER_RX_IT){tmpisr|=I2C_IT_ERRI|I2C_IT_TCI|I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_RXI;}if(InterruptRequest==I2C_XFER_ERROR_IT){tmpisr|=I2C_IT_ERRI|I2C_IT_NACKI;}if(InterruptRequest==I2C_XFER_CPLT_IT){tmpisr|=(I2C_IT_STOPI|I2C_IT_TCI);}if(InterruptRequest==I2C_XFER_RELOAD_IT){tmpisr|=I2C_IT_TCI;}}__HAL_I2C_ENABLE_IT(hi2c,tmpisr);}staticvoidI2C_Disable_IRQ(I2C_HandleTypeDef*hi2c,uint16_tInterruptRequest){uint32_ttmpisr=0U;if((InterruptRequest&I2C_XFER_TX_IT)==I2C_XFER_TX_IT){tmpisr|=I2C_IT_TCI|I2C_IT_TXI;if(((uint32_t)hi2c->State&(uint32_t)HAL_I2C_STATE_LISTEN)!=(uint32_t)HAL_I2C_STATE_LISTEN){tmpisr|=I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_ERRI;}}if((InterruptRequest&I2C_XFER_RX_IT)==I2C_XFER_RX_IT){tmpisr|=I2C_IT_TCI|I2C_IT_RXI;if(((uint32_t)hi2c->State&(uint32_t)HAL_I2C_STATE_LISTEN)!=(uint32_t)HAL_I2C_STATE_LISTEN){tmpisr|=I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_ERRI;}}if((InterruptRequest&I2C_XFER_LISTEN_IT)==I2C_XFER_LISTEN_IT){tmpisr|=I2C_IT_ADDRI|I2C_IT_STOPI|I2C_IT_NACKI|I2C_IT_ERRI;}if(InterruptRequest==I2C_XFER_ERROR_IT){tmpisr|=I2C_IT_ERRI|I2C_IT_NACKI;}if(InterruptRequest==I2C_XFER_CPLT_IT){tmpisr|=I2C_IT_STOPI;}if(InterruptRequest==I2C_XFER_RELOAD_IT){tmpisr|=I2C_IT_TCI;}__HAL_I2C_DISABLE_IT(hi2c,tmpisr);}staticvoidI2C_ConvertOtherXferOptions(I2C_HandleTypeDef*hi2c){if(hi2c->XferOptions==I2C_OTHER_FRAME){hi2c->XferOptions=I2C_FIRST_FRAME;}elseif(hi2c->XferOptions==I2C_OTHER_AND_LAST_FRAME){hi2c->XferOptions=I2C_FIRST_AND_LAST_FRAME;}else{}}#endif