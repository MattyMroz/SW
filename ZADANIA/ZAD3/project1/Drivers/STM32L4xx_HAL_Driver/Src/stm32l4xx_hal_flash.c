#include"stm32l4xx_hal.h"#ifdefHAL_FLASH_MODULE_ENABLED#ifdefined(STM32L4P5xx)||defined(STM32L4Q5xx)||defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)#defineFLASH_NB_DOUBLE_WORDS_IN_ROW64#else#defineFLASH_NB_DOUBLE_WORDS_IN_ROW32#endifFLASH_ProcessTypeDefpFlash={.Lock=HAL_UNLOCKED,\.ErrorCode=HAL_FLASH_ERROR_NONE,\.ProcedureOnGoing=FLASH_PROC_NONE,\.Address=0U,\.Bank=FLASH_BANK_1,\.Page=0U,\.NbPagesToErase=0U,\.CacheToReactivate=FLASH_CACHE_DISABLED};staticvoidFLASH_Program_DoubleWord(uint32_tAddress,uint64_tData);staticvoidFLASH_Program_Fast(uint32_tAddress,uint32_tDataAddress);HAL_StatusTypeDefHAL_FLASH_Program(uint32_tTypeProgram,uint32_tAddress,uint64_tData){HAL_StatusTypeDefstatus;uint32_tprog_bit=0;__HAL_LOCK(&pFlash);assert_param(IS_FLASH_TYPEPROGRAM(TypeProgram));status=FLASH_WaitForLastOperation((uint32_t)FLASH_TIMEOUT_VALUE);if(status==HAL_OK){pFlash.ErrorCode=HAL_FLASH_ERROR_NONE;if(READ_BIT(FLASH->ACR,FLASH_ACR_DCEN)!=0U){__HAL_FLASH_DATA_CACHE_DISABLE();pFlash.CacheToReactivate=FLASH_CACHE_DCACHE_ENABLED;}else{pFlash.CacheToReactivate=FLASH_CACHE_DISABLED;}if(TypeProgram==FLASH_TYPEPROGRAM_DOUBLEWORD){FLASH_Program_DoubleWord(Address,Data);prog_bit=FLASH_CR_PG;}elseif((TypeProgram==FLASH_TYPEPROGRAM_FAST)||(TypeProgram==FLASH_TYPEPROGRAM_FAST_AND_LAST)){FLASH_Program_Fast(Address,(uint32_t)Data);if(TypeProgram==FLASH_TYPEPROGRAM_FAST_AND_LAST){prog_bit=FLASH_CR_FSTPG;}}else{}status=FLASH_WaitForLastOperation((uint32_t)FLASH_TIMEOUT_VALUE);if(prog_bit!=0U){CLEAR_BIT(FLASH->CR,prog_bit);}FLASH_FlushCaches();}__HAL_UNLOCK(&pFlash);returnstatus;}HAL_StatusTypeDefHAL_FLASH_Program_IT(uint32_tTypeProgram,uint32_tAddress,uint64_tData){HAL_StatusTypeDefstatus=HAL_OK;assert_param(IS_FLASH_TYPEPROGRAM(TypeProgram));__HAL_LOCK(&pFlash);pFlash.ErrorCode=HAL_FLASH_ERROR_NONE;if(READ_BIT(FLASH->ACR,FLASH_ACR_DCEN)!=0U){__HAL_FLASH_DATA_CACHE_DISABLE();pFlash.CacheToReactivate=FLASH_CACHE_DCACHE_ENABLED;}else{pFlash.CacheToReactivate=FLASH_CACHE_DISABLED;}if(TypeProgram==FLASH_TYPEPROGRAM_FAST_AND_LAST){pFlash.ProcedureOnGoing=FLASH_PROC_PROGRAM_LAST;}else{pFlash.ProcedureOnGoing=FLASH_PROC_PROGRAM;}pFlash.Address=Address;__HAL_FLASH_ENABLE_IT(FLASH_IT_EOP|FLASH_IT_OPERR);if(TypeProgram==FLASH_TYPEPROGRAM_DOUBLEWORD){FLASH_Program_DoubleWord(Address,Data);}elseif((TypeProgram==FLASH_TYPEPROGRAM_FAST)||(TypeProgram==FLASH_TYPEPROGRAM_FAST_AND_LAST)){FLASH_Program_Fast(Address,(uint32_t)Data);}else{}returnstatus;}voidHAL_FLASH_IRQHandler(void){uint32_ttmp_page;uint32_terror;FLASH_ProcedureTypeDefprocedure;CLEAR_BIT(FLASH->CR,(FLASH_CR_PG|FLASH_CR_MER1|FLASH_CR_PER|FLASH_CR_PNB));#ifdefined(STM32L471xx)||defined(STM32L475xx)||defined(STM32L476xx)||defined(STM32L485xx)||defined(STM32L486xx)||\defined(STM32L496xx)||defined(STM32L4A6xx)||\defined(STM32L4P5xx)||defined(STM32L4Q5xx)||\defined(STM32L4R5xx)||defined(STM32L4R7xx)||defined(STM32L4R9xx)||defined(STM32L4S5xx)||defined(STM32L4S7xx)||defined(STM32L4S9xx)CLEAR_BIT(FLASH->CR,FLASH_CR_MER2);#endifif(pFlash.ProcedureOnGoing==FLASH_PROC_PROGRAM_LAST){CLEAR_BIT(FLASH->CR,FLASH_CR_FSTPG);}error=(FLASH->SR&FLASH_FLAG_SR_ERRORS);if(error!=0U){pFlash.ErrorCode|=error;__HAL_FLASH_CLEAR_FLAG(error);FLASH_FlushCaches();procedure=pFlash.ProcedureOnGoing;if(procedure==FLASH_PROC_PAGE_ERASE){HAL_FLASH_OperationErrorCallback(pFlash.Page);}elseif(procedure==FLASH_PROC_MASS_ERASE){HAL_FLASH_OperationErrorCallback(pFlash.Bank);}elseif((procedure==FLASH_PROC_PROGRAM)||(procedure==FLASH_PROC_PROGRAM_LAST)){HAL_FLASH_OperationErrorCallback(pFlash.Address);}else{HAL_FLASH_OperationErrorCallback(0U);}pFlash.ProcedureOnGoing=FLASH_PROC_NONE;}if(__HAL_FLASH_GET_FLAG(FLASH_FLAG_EOP)!=0U){__HAL_FLASH_CLEAR_FLAG(FLASH_FLAG_EOP);if(pFlash.ProcedureOnGoing==FLASH_PROC_PAGE_ERASE){pFlash.NbPagesToErase--;if(pFlash.NbPagesToErase!=0U){HAL_FLASH_EndOfOperationCallback(pFlash.Page);pFlash.Page++;tmp_page=pFlash.Page;FLASH_PageErase(tmp_page,pFlash.Bank);}else{pFlash.Page=0xFFFFFFFFU;pFlash.ProcedureOnGoing=FLASH_PROC_NONE;FLASH_FlushCaches();HAL_FLASH_EndOfOperationCallback(pFlash.Page);}}else{FLASH_FlushCaches();procedure=pFlash.ProcedureOnGoing;if(procedure==FLASH_PROC_MASS_ERASE){HAL_FLASH_EndOfOperationCallback(pFlash.Bank);}elseif((procedure==FLASH_PROC_PROGRAM)||(procedure==FLASH_PROC_PROGRAM_LAST)){HAL_FLASH_EndOfOperationCallback(pFlash.Address);}else{}pFlash.ProcedureOnGoing=FLASH_PROC_NONE;}}if(pFlash.ProcedureOnGoing==FLASH_PROC_NONE){__HAL_FLASH_DISABLE_IT(FLASH_IT_EOP|FLASH_IT_OPERR);__HAL_UNLOCK(&pFlash);}}__weakvoidHAL_FLASH_EndOfOperationCallback(uint32_tReturnValue){UNUSED(ReturnValue);}__weakvoidHAL_FLASH_OperationErrorCallback(uint32_tReturnValue){UNUSED(ReturnValue);}HAL_StatusTypeDefHAL_FLASH_Unlock(void){HAL_StatusTypeDefstatus=HAL_OK;if(READ_BIT(FLASH->CR,FLASH_CR_LOCK)!=0U){WRITE_REG(FLASH->KEYR,FLASH_KEY1);WRITE_REG(FLASH->KEYR,FLASH_KEY2);if(READ_BIT(FLASH->CR,FLASH_CR_LOCK)!=0U){status=HAL_ERROR;}}returnstatus;}HAL_StatusTypeDefHAL_FLASH_Lock(void){SET_BIT(FLASH->CR,FLASH_CR_LOCK);returnHAL_OK;}HAL_StatusTypeDefHAL_FLASH_OB_Unlock(void){if(READ_BIT(FLASH->CR,FLASH_CR_OPTLOCK)!=0U){WRITE_REG(FLASH->OPTKEYR,FLASH_OPTKEY1);WRITE_REG(FLASH->OPTKEYR,FLASH_OPTKEY2);}else{returnHAL_ERROR;}returnHAL_OK;}HAL_StatusTypeDefHAL_FLASH_OB_Lock(void){SET_BIT(FLASH->CR,FLASH_CR_OPTLOCK);returnHAL_OK;}HAL_StatusTypeDefHAL_FLASH_OB_Launch(void){SET_BIT(FLASH->CR,FLASH_CR_OBL_LAUNCH);return(FLASH_WaitForLastOperation((uint32_t)FLASH_TIMEOUT_VALUE));}uint32_tHAL_FLASH_GetError(void){returnpFlash.ErrorCode;}HAL_StatusTypeDefFLASH_WaitForLastOperation(uint32_tTimeout){uint32_ttickstart=HAL_GetTick();uint32_terror;while(__HAL_FLASH_GET_FLAG(FLASH_FLAG_BSY)){if(Timeout!=HAL_MAX_DELAY){if((HAL_GetTick()-tickstart)>=Timeout){returnHAL_TIMEOUT;}}}error=(FLASH->SR&FLASH_FLAG_SR_ERRORS);if(error!=0u){pFlash.ErrorCode|=error;__HAL_FLASH_CLEAR_FLAG(error);returnHAL_ERROR;}if(__HAL_FLASH_GET_FLAG(FLASH_FLAG_EOP)){__HAL_FLASH_CLEAR_FLAG(FLASH_FLAG_EOP);}returnHAL_OK;}staticvoidFLASH_Program_DoubleWord(uint32_tAddress,uint64_tData){assert_param(IS_FLASH_PROGRAM_ADDRESS(Address));SET_BIT(FLASH->CR,FLASH_CR_PG);*(__IOuint32_t*)Address=(uint32_t)Data;__ISB();*(__IOuint32_t*)(Address+4U)=(uint32_t)(Data>>32);}staticvoidFLASH_Program_Fast(uint32_tAddress,uint32_tDataAddress){uint32_tprimask_bit;uint8_trow_index=(2*FLASH_NB_DOUBLE_WORDS_IN_ROW);__IOuint32_t*dest_addr=(__IOuint32_t*)Address;__IOuint32_t*src_addr=(__IOuint32_t*)DataAddress;assert_param(IS_FLASH_MAIN_MEM_ADDRESS(Address));SET_BIT(FLASH->CR,FLASH_CR_FSTPG);primask_bit=__get_PRIMASK();__disable_irq();do{*dest_addr=*src_addr;dest_addr++;src_addr++;row_index--;}while(row_index!=0U);__set_PRIMASK(primask_bit);}#endif